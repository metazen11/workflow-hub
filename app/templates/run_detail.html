{% extends "base.html" %}

{% block title %}{{ run.name }} - Workflow Hub{% endblock %}
{% block page_title %}{{ run.name }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span class="badge badge-{{ run.state_class }}" style="font-size: 1rem;">{{ run.state|upper }}</span>
            {% if run.killed %}
            <span class="badge badge-danger" style="margin-left: 8px;">KILLED</span>
            {% endif %}
        </div>
        <div>
            <a href="/ui/project/{{ run.project_id }}/" class="btn btn-sm">
                Back to Project
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Meta information -->
        <div class="detail-meta">
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Created: <strong>{{ run.created_at }}</strong></span>
            </div>
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>Project: <a href="/ui/project/{{ run.project_id }}/">{{ run.project_name }}</a></span>
            </div>
        </div>

        <!-- Pipeline Progress -->
        <div class="section">
            <h4 class="section-title">Pipeline Progress</h4>
            <div class="pipeline-stages">
                {% for stage in pipeline_stages %}
                <div class="pipeline-stage {% if stage.name == run.state %}active{% endif %} {% if stage.completed %}completed{% endif %} {% if stage.failed %}failed{% endif %}">
                    <div class="stage-dot"></div>
                    <span class="stage-name">{{ stage.label }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- State Controls -->
        <div class="section">
            <h4 class="section-title">Run Controls</h4>
            <div class="control-group">
                <!-- State Change Dropdown -->
                <div class="control-item">
                    <label>Change State:</label>
                    <select id="state-select" class="form-select">
                        <option value="">-- Select State --</option>
                        {% for state in all_states %}
                        <option value="{{ state }}" {% if state == run.state %}selected{% endif %}>{{ state|upper }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary" onclick="changeState()">Apply</button>
                </div>

                <!-- Action Buttons -->
                <div class="control-item">
                    <label>Actions:</label>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="advanceState()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Advance
                        </button>
                        {% if run.is_failed %}
                        <button class="btn btn-warning" onclick="retryStage()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                            Retry
                        </button>
                        <button class="btn btn-secondary" onclick="resetToDev()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            Reset to DEV
                        </button>
                        {% endif %}
                        {% if run.is_ready_for_deploy %}
                        <button class="btn btn-success" onclick="approveDeploy()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Approve Deploy
                        </button>
                        {% endif %}
                        {% if not run.killed %}
                        <button class="btn btn-danger" onclick="killRun()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Kill Run
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Trigger Agent with Prompt -->
        <div class="section">
            <h4 class="section-title">Trigger Agent</h4>
            <div class="agent-trigger-form">
                <div class="form-group">
                    <label>Select Agent:</label>
                    <select id="agent-select" class="form-select">
                        <option value="pm">PM (Product Manager)</option>
                        <option value="dev" selected>DEV (Developer)</option>
                        <option value="qa">QA (Quality Assurance)</option>
                        <option value="sec">Security</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Additional Instructions (optional):</label>
                    <textarea id="agent-prompt" class="form-textarea" rows="3" placeholder="Add specific instructions for the agent..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="triggerAgent()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Run Agent
                </button>
            </div>
        </div>

        <!-- Agent Reports -->
        <div class="section">
            <h4 class="section-title">Agent Reports</h4>
            <div class="reports-grid">
                {% for role, result in run.results.items %}
                {% if result %}
                <div class="report-card {% if result.status == 'pass' %}pass{% elif result.status == 'fail' %}fail{% endif %}">
                    <div class="report-header">
                        <strong>{{ role|upper }}</strong>
                        <span class="badge {% if result.status == 'pass' %}badge-success{% elif result.status == 'fail' %}badge-danger{% else %}badge-secondary{% endif %}">
                            {{ result.status|upper }}
                        </span>
                    </div>
                    {% if result.summary %}
                    <p class="report-summary">{{ result.summary }}</p>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Project Tasks -->
        <div class="section">
            <h4 class="section-title">
                Project Tasks
                <span class="section-count">({{ project_task_count }} total{% if run_task_count %}, {{ run_task_count }} linked to run{% endif %})</span>
            </h4>
            {% if tasks %}
            <div class="tasks-list">
                {% for task in tasks %}
                <div class="task-row {% if task.linked_to_run %}linked-to-run{% endif %}">
                    <div class="task-info">
                        <span class="task-id">{{ task.task_id }}</span>
                        <a href="/ui/task/{{ task.id }}/" class="task-title">{{ task.title }}</a>
                        <span class="badge badge-{{ task.status_class }}">{{ task.status|upper }}</span>
                        {% if task.linked_to_run %}
                        <span class="badge badge-info" title="Task linked to this run">RUN</span>
                        {% endif %}
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-sm edit-task-btn"
                            data-task-id="{{ task.id }}"
                            data-title="{{ task.title }}"
                            data-description="{{ task.description }}"
                            data-priority="{{ task.priority }}"
                            data-status="{{ task.status }}"
                            data-blocked-by="{{ task.blocked_by }}"
                            data-acceptance="{{ task.acceptance_criteria }}">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-task-btn"
                            data-task-id="{{ task.id }}"
                            data-title="{{ task.title }}"
                            title="Delete task">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); font-style: italic;">No tasks in this project yet</p>
            {% endif %}

            <!-- Add Task Button -->
            <div style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="openTaskModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Task
                </button>
            </div>
        </div>

        <!-- Audit Log -->
        <div class="section">
            <h4 class="section-title">Activity Log</h4>
            <div class="audit-log">
                {% for event in audit_events %}
                <div class="audit-event">
                    <span class="audit-time">{{ event.timestamp }}</span>
                    <span class="audit-actor">{{ event.actor }}</span>
                    <span class="audit-action">{{ event.action }}</span>
                    {% if event.details %}
                    <span class="audit-details">{{ event.details }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Modal (Add/Edit) -->
<div id="task-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="task-modal-title">Add Task</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="task-id">

            <div class="form-group">
                <label>Title: <span class="required">*</span></label>
                <input type="text" id="task-title" class="form-input" placeholder="Task title..." required>
            </div>

            <div class="form-group">
                <label>Description:</label>
                <textarea id="task-description" class="form-textarea" rows="4" placeholder="Detailed description of what needs to be done..."></textarea>
            </div>

            <div class="form-row" style="gap: 16px;">
                <div class="form-group" style="flex: 1;">
                    <label>Priority (1-10):</label>
                    <input type="number" id="task-priority" class="form-input" min="1" max="10" value="5">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Status:</label>
                    <select id="task-status" class="form-select">
                        <option value="backlog">Backlog</option>
                        <option value="in_progress">In Progress</option>
                        <option value="blocked">Blocked</option>
                        <option value="done">Done</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Blocked By (comma-separated task IDs):</label>
                <input type="text" id="task-blocked-by" class="form-input" placeholder="e.g., T001, T002">
            </div>

            <div class="form-group">
                <label>Acceptance Criteria (one per line):</label>
                <textarea id="task-acceptance" class="form-textarea" rows="3" placeholder="- Criterion 1&#10;- Criterion 2&#10;- Criterion 3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeTaskModal()">Cancel</button>
            <button class="btn btn-primary" id="task-save-btn" onclick="saveTask()">Save</button>
        </div>
    </div>
</div>

<style>
.pipeline-stages {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 16px 0;
}
.pipeline-stage {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--bg-secondary);
    border-radius: 20px;
    font-size: 0.85rem;
}
.pipeline-stage .stage-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}
.pipeline-stage.active {
    background: var(--accent);
    color: white;
}
.pipeline-stage.active .stage-dot {
    background: white;
}
.pipeline-stage.completed .stage-dot {
    background: var(--success);
}
.pipeline-stage.failed {
    background: var(--danger);
    color: white;
}
.pipeline-stage.failed .stage-dot {
    background: white;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.control-item {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.control-item label {
    min-width: 120px;
    font-weight: 500;
}
.btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.agent-trigger-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.agent-trigger-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}
.report-card {
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border-left: 4px solid var(--border);
}
.report-card.pass {
    border-left-color: var(--success);
}
.report-card.fail {
    border-left-color: var(--danger);
}
.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}
.report-summary {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
}

.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.task-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
}
.task-info {
    display: flex;
    align-items: center;
    gap: 12px;
}
.task-id {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--text-muted);
}
.task-title {
    color: var(--text-primary);
    text-decoration: none;
}
.task-title:hover {
    text-decoration: underline;
}
.task-row.linked-to-run {
    border-left: 3px solid var(--accent);
}
.section-count {
    font-weight: normal;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.form-row {
    display: flex;
    gap: 8px;
}

.audit-log {
    max-height: 300px;
    overflow-y: auto;
}
.audit-event {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
}
.audit-time {
    color: var(--text-muted);
    font-family: monospace;
    font-size: 0.8rem;
}
.audit-actor {
    font-weight: 500;
    min-width: 80px;
}
.audit-action {
    color: var(--text-secondary);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: var(--bg-primary);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.modal-header h3 {
    margin: 0;
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
}
.modal-body {
    padding: 20px;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
}
</style>

<script>
const runId = {{ run.id }};
const projectId = {{ run.project_id }};

function changeState() {
    const state = document.getElementById('state-select').value;
    if (!state) return;

    fetch(`/api/runs/${runId}/set-state`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: state })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error changing state'));
}

function advanceState() {
    fetch(`/api/runs/${runId}/advance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error advancing state'));
}

function retryStage() {
    fetch(`/api/runs/${runId}/retry`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error retrying stage'));
}

function resetToDev() {
    if (!confirm('Reset to DEV stage? This will create tasks from findings.')) return;

    fetch(`/api/runs/${runId}/reset-to-dev`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error resetting to dev'));
}

function approveDeploy() {
    if (!confirm('Approve deployment?')) return;

    fetch(`/api/runs/${runId}/approve-deploy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error approving deploy'));
}

function killRun() {
    if (!confirm('Kill this run? This cannot be undone.')) return;

    fetch(`/api/runs/${runId}/kill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error killing run'));
}

function triggerAgent() {
    const agent = document.getElementById('agent-select').value;
    const prompt = document.getElementById('agent-prompt').value;

    // Show loading state
    const btn = document.querySelector('.trigger-agent-btn');
    const originalText = btn ? btn.innerHTML : '';
    if (btn) {
        btn.innerHTML = '<svg class="spinner" width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/></svg> Starting...';
        btn.disabled = true;
    }

    // Call the trigger-agent API
    fetch(`/api/runs/${runId}/trigger-agent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            agent: agent,
            prompt: prompt || null,
            async: true
        })
    })
    .then(r => r.json())
    .then(data => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        if (data.status === 'started') {
            alert(`Agent ${agent.toUpperCase()} started! It will run in the background and submit results when complete.`);
            // Start polling for state changes
            setTimeout(() => window.location.reload(), 3000);
        } else if (data.error || data.message) {
            alert('Error: ' + (data.error || data.message));
        }
    })
    .catch(err => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        alert('Error triggering agent: ' + err);
    });
}

function triggerPipeline() {
    if (!confirm('Start the full pipeline? This will run PM → DEV → QA → SEC automatically.')) {
        return;
    }

    fetch(`/api/runs/${runId}/trigger-pipeline`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ max_iterations: 10 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'started') {
            alert('Pipeline started! It will run in the background. Refresh the page to see progress.');
        } else {
            alert('Error: ' + (data.error || data.message));
        }
    })
    .catch(err => alert('Error starting pipeline: ' + err));
}

// ============================================
// Unified Task Modal (DRY - Add/Edit)
// ============================================
let isEditMode = false;

function openTaskModal(taskData = null) {
    const modal = document.getElementById('task-modal');
    const title = document.getElementById('task-modal-title');
    const saveBtn = document.getElementById('task-save-btn');

    // Reset form
    document.getElementById('task-id').value = '';
    document.getElementById('task-title').value = '';
    document.getElementById('task-description').value = '';
    document.getElementById('task-priority').value = '5';
    document.getElementById('task-status').value = 'backlog';
    document.getElementById('task-blocked-by').value = '';
    document.getElementById('task-acceptance').value = '';

    if (taskData) {
        // Edit mode
        isEditMode = true;
        title.textContent = 'Edit Task';
        saveBtn.textContent = 'Update';

        document.getElementById('task-id').value = taskData.id;
        document.getElementById('task-title').value = taskData.title || '';
        document.getElementById('task-description').value = taskData.description || '';
        document.getElementById('task-priority').value = taskData.priority || 5;
        document.getElementById('task-status').value = taskData.status || 'backlog';
        document.getElementById('task-blocked-by').value = (taskData.blocked_by || []).join(', ');
        document.getElementById('task-acceptance').value = (taskData.acceptance_criteria || []).join('\n');
    } else {
        // Add mode
        isEditMode = false;
        title.textContent = 'Add Task';
        saveBtn.textContent = 'Create';
    }

    modal.style.display = 'flex';
    document.getElementById('task-title').focus();
}

function closeTaskModal() {
    document.getElementById('task-modal').style.display = 'none';
}

// Event delegation for edit buttons (more robust than inline onclick)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.edit-task-btn');
    if (!btn) return;

    const blockedBy = btn.dataset.blockedBy || '';
    const acceptance = btn.dataset.acceptance || '';

    openTaskModal({
        id: btn.dataset.taskId,
        title: btn.dataset.title || '',
        description: btn.dataset.description || '',
        priority: parseInt(btn.dataset.priority) || 5,
        status: btn.dataset.status || 'backlog',
        blocked_by: blockedBy ? blockedBy.split(',').map(s => s.trim()).filter(s => s) : [],
        acceptance_criteria: acceptance ? acceptance.split('\n').filter(s => s.trim()) : []
    });
});

// Delete button handler is in /static/js/task-actions.js (DRY)

function saveTask() {
    const taskId = document.getElementById('task-id').value;
    const title = document.getElementById('task-title').value.trim();
    const description = document.getElementById('task-description').value.trim();
    const priority = parseInt(document.getElementById('task-priority').value) || 5;
    const status = document.getElementById('task-status').value;
    const blockedByStr = document.getElementById('task-blocked-by').value.trim();
    const acceptanceStr = document.getElementById('task-acceptance').value.trim();

    if (!title) {
        alert('Title is required');
        return;
    }

    // Parse blocked_by and acceptance_criteria
    const blocked_by = blockedByStr ? blockedByStr.split(',').map(s => s.trim()).filter(s => s) : [];
    const acceptance_criteria = acceptanceStr ? acceptanceStr.split('\n').filter(s => s.trim()) : [];

    const payload = {
        title,
        description,
        priority,
        blocked_by,
        acceptance_criteria,
        run_id: runId
    };

    let url, method;
    if (isEditMode && taskId) {
        // Update existing task
        url = `/api/tasks/${taskId}/update`;
        method = 'PATCH';
        // Also update status
        payload.status = status;
    } else {
        // Create new task
        url = `/api/projects/${projectId}/tasks/create`;
        method = 'POST';
    }

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            closeTaskModal();
            window.location.reload();
        }
    })
    .catch(err => alert('Error saving task: ' + err.message));
}

// Close modal on click outside
document.getElementById('task-modal').addEventListener('click', function(e) {
    if (e.target === this) closeTaskModal();
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTaskModal();
    }
});
</script>
{% endblock %}
