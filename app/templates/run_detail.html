{% extends "base.html" %}

{% block title %}{{ run.name }} - Workflow Hub{% endblock %}
{% block page_title %}{{ run.name }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span class="badge badge-{{ run.state_class }}" style="font-size: 1rem;">{{ run.state|upper }}</span>
            {% if run.killed %}
            <span class="badge badge-danger" style="margin-left: 8px;">KILLED</span>
            {% endif %}
        </div>
        <div>
            <a href="/ui/project/{{ run.project_id }}/" class="btn btn-sm">
                Back to Project
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Meta information -->
        <div class="detail-meta">
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Created: <strong>{{ run.created_at }}</strong></span>
            </div>
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>Project: <a href="/ui/project/{{ run.project_id }}/">{{ run.project_name }}</a></span>
            </div>
        </div>

        <!-- Pipeline Progress -->
        <div class="section">
            <h4 class="section-title">Pipeline Progress</h4>
            <div class="pipeline-stages">
                {% for stage in pipeline_stages %}
                <div class="pipeline-stage {% if stage.name == run.state %}active{% endif %} {% if stage.completed %}completed{% endif %} {% if stage.failed %}failed{% endif %}">
                    <div class="stage-dot"></div>
                    <span class="stage-name">{{ stage.label }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- State Controls -->
        <div class="section">
            <h4 class="section-title">Run Controls</h4>
            <div class="control-group">
                <!-- State Change Dropdown -->
                <div class="control-item">
                    <label>Change State:</label>
                    <select id="state-select" class="form-select">
                        <option value="">-- Select State --</option>
                        {% for state in all_states %}
                        <option value="{{ state }}" {% if state == run.state %}selected{% endif %}>{{ state|upper }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary" onclick="changeState()">Apply</button>
                </div>

                <!-- Action Buttons -->
                <div class="control-item">
                    <label>Actions:</label>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="advanceState()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Advance
                        </button>
                        {% if run.is_failed %}
                        <button class="btn btn-warning" onclick="retryStage()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                            Retry
                        </button>
                        <button class="btn btn-secondary" onclick="resetToDev()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            Reset to DEV
                        </button>
                        {% endif %}
                        {% if run.is_ready_for_deploy %}
                        <button class="btn btn-success" onclick="approveDeploy()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Approve Deploy
                        </button>
                        {% endif %}
                        {% if run.can_deploy %}
                        <!-- React-powered Deploy button -->
                        <div id="deploy-button-container" style="display: inline-block;"></div>
                        {% endif %}
                        {% if run.can_rollback %}
                        <!-- React-powered Rollback button -->
                        <div id="rollback-button-container" style="display: inline-block;"></div>
                        {% endif %}
                        {% if not run.killed %}
                        <button class="btn btn-danger" onclick="killRun()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Kill Run
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Trigger Agent with Prompt -->
        <div class="section">
            <h4 class="section-title">Trigger Agent</h4>
            <div class="agent-trigger-form">
                <div class="form-group">
                    <label>Select Agent:</label>
                    <select id="agent-select" class="form-select">
                        <option value="pm">PM (Product Manager)</option>
                        <option value="dev" selected>DEV (Developer)</option>
                        <option value="qa">QA (Quality Assurance)</option>
                        <option value="sec">Security</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Additional Instructions (optional):</label>
                    <textarea id="agent-prompt" class="form-textarea" rows="3" placeholder="Add specific instructions for the agent..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="triggerAgent()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Run Agent
                </button>
            </div>
        </div>

        <!-- Agent Reports -->
        <div class="section">
            <h4 class="section-title">Agent Reports</h4>
            <div class="reports-grid">
                {% for role, result in run.results.items %}
                {% if result %}
                <div class="report-card {% if result.status == 'pass' %}pass{% elif result.status == 'fail' %}fail{% endif %}"
                     onclick="toggleReportDetails(this)"
                     style="cursor: pointer;">
                    <div class="report-header">
                        <strong>{{ role|upper }}</strong>
                        <span class="badge {% if result.status == 'pass' %}badge-success{% elif result.status == 'fail' %}badge-danger{% else %}badge-secondary{% endif %}">
                            {{ result.status|upper }}
                        </span>
                    </div>
                    {% if result.summary %}
                    <p class="report-summary">{{ result.summary }}</p>
                    {% endif %}
                    <div class="report-details" style="display: none;">
                        {% if result.details %}
                        <hr style="margin: 8px 0; border-color: var(--border);">
                        <div class="report-details-content">
                            {% if result.details.failing_tests %}
                            <div class="detail-section">
                                <strong style="color: var(--danger);">Failing Tests:</strong>
                                <ul style="margin: 4px 0; padding-left: 20px;">
                                    {% for test in result.details.failing_tests %}
                                    <li>{{ test }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if result.details.issues %}
                            <div class="detail-section">
                                <strong style="color: var(--warning);">Issues:</strong>
                                <ul style="margin: 4px 0; padding-left: 20px;">
                                    {% for issue in result.details.issues %}
                                    <li>{{ issue }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if result.details.vulnerabilities %}
                            <div class="detail-section">
                                <strong style="color: var(--danger);">Vulnerabilities:</strong>
                                <ul style="margin: 4px 0; padding-left: 20px;">
                                    {% for vuln in result.details.vulnerabilities %}
                                    <li>
                                        {% if vuln.severity %}<span class="badge badge-{% if vuln.severity == 'critical' or vuln.severity == 'high' %}danger{% elif vuln.severity == 'medium' %}warning{% else %}secondary{% endif %}" style="font-size: 0.7rem;">{{ vuln.severity|upper }}</span>{% endif %}
                                        {{ vuln.title|default:vuln.issue|default:vuln }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if result.details.errors %}
                            <div class="detail-section">
                                <strong style="color: var(--danger);">Errors:</strong>
                                <ul style="margin: 4px 0; padding-left: 20px;">
                                    {% for error in result.details.errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if result.details.error %}
                            <div class="detail-section">
                                <strong style="color: var(--danger);">Error:</strong>
                                <pre style="margin: 4px 0; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word;">{{ result.details.error }}</pre>
                            </div>
                            {% endif %}
                            {% if result.details.output %}
                            <div class="detail-section">
                                <strong>Output:</strong>
                                <pre style="margin: 4px 0; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 0.8rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">{{ result.details.output }}</pre>
                            </div>
                            {% endif %}
                            {% if not result.details.failing_tests and not result.details.issues and not result.details.vulnerabilities and not result.details.errors and not result.details.error and not result.details.output %}
                            <pre style="font-size: 0.75rem; background: var(--bg-primary); padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">{{ result.details|pprint }}</pre>
                            {% endif %}
                        </div>
                        {% else %}
                        <p style="font-style: italic; color: var(--text-muted); font-size: 0.85rem; margin: 8px 0 0;">No additional details available</p>
                        {% endif %}
                    </div>
                    <div class="expand-hint" style="text-align: center; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
                        <span class="expand-text">â–¼ Click to view details</span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Project Tasks -->
        <div class="section">
            <h4 class="section-title">
                Project Tasks
                <span class="section-count">({{ project_task_count }} total{% if run_task_count %}, {{ run_task_count }} linked to run{% endif %})</span>
            </h4>

            <!-- Task Filters -->
            <div class="task-filters">
                <div class="filter-group">
                    <label>Status:</label>
                    <select id="filter-status" onchange="filterTasks()">
                        <option value="">All</option>
                        <option value="backlog">Backlog</option>
                        <option value="in_progress">In Progress</option>
                        <option value="done">Done</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Pipeline Stage:</label>
                    <select id="filter-stage" onchange="filterTasks()">
                        <option value="">All</option>
                        <option value="none">Not Started</option>
                        <option value="dev">DEV</option>
                        <option value="qa">QA</option>
                        <option value="sec">SEC</option>
                        <option value="docs">DOCS</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Linked:</label>
                    <select id="filter-linked" onchange="filterTasks()">
                        <option value="">All</option>
                        <option value="true">This Run</option>
                        <option value="false">Project Only</option>
                    </select>
                </div>
                <button class="btn btn-sm" onclick="clearFilters()">Clear</button>
            </div>

            {% if tasks %}
            <table class="tasks-table" id="tasks-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Stage</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for task in tasks %}
                <tr class="task-row {% if task.linked_to_run %}linked-to-run{% endif %}"
                    data-status="{{ task.status }}"
                    data-stage="{{ task.pipeline_stage }}"
                    data-linked="{{ task.linked_to_run|lower }}">
                    <td class="task-id">{{ task.task_id }}</td>
                    <td>
                        <a href="/ui/task/{{ task.id }}/" class="task-title">{{ task.title }}</a>
                        {% if task.linked_to_run %}
                        <span class="badge badge-info badge-sm" title="Task linked to this run">RUN</span>
                        {% endif %}
                    </td>
                    <td><span class="badge badge-{{ task.status_class }}">{{ task.status|upper }}</span></td>
                    <td><span class="badge badge-{{ task.pipeline_stage_class }}">{{ task.pipeline_stage|upper }}</span></td>
                    <td class="priority-cell">{{ task.priority }}</td>
                    <td class="task-actions">
                        <button class="btn btn-sm btn-success trigger-task-btn"
                            data-task-id="{{ task.id }}"
                            data-stage="{{ task.pipeline_stage }}"
                            title="Trigger work on this task">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                        <button class="btn btn-sm edit-task-btn"
                            data-task-id="{{ task.id }}"
                            data-title="{{ task.title }}"
                            data-description="{{ task.description }}"
                            data-priority="{{ task.priority }}"
                            data-status="{{ task.status }}"
                            data-pipeline-stage="{{ task.pipeline_stage }}"
                            data-blocked-by="{{ task.blocked_by }}"
                            data-acceptance="{{ task.acceptance_criteria }}">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-sm btn-danger delete-task-btn"
                            data-task-id="{{ task.id }}"
                            data-title="{{ task.title }}"
                            title="Delete task">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: var(--text-muted); font-style: italic;">No tasks in this project yet</p>
            {% endif %}

            <!-- Add Task Button -->
            <div style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="openTaskModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Task
                </button>
            </div>
        </div>

        <!-- Proof-of-Work Artifacts -->
        <div class="section">
            <h4 class="section-title">Proof-of-Work Artifacts</h4>
            <div id="proofs-container">
                <p style="color: var(--text-muted); font-style: italic;">Loading proofs...</p>
            </div>
            <div class="upload-section" style="margin-top: 16px;">
                <h5>Upload Proof</h5>
                <form id="proof-upload-form" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Stage</label>
                        <select id="proof-stage" class="form-select" style="width: 120px;">
                            <option value="dev">DEV</option>
                            <option value="qa">QA</option>
                            <option value="sec">SEC</option>
                            <option value="docs">DOCS</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Type</label>
                        <select id="proof-type" class="form-select" style="width: 120px;">
                            <option value="screenshot">Screenshot</option>
                            <option value="log">Log</option>
                            <option value="report">Report</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <input type="file" id="proof-file" name="file" accept=".png,.jpg,.jpeg,.gif,.txt,.log,.md,.json,.xml,.csv" style="min-width: 200px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>

        <!-- Audit Log -->
        <div class="section">
            <h4 class="section-title">Activity Log</h4>
            <div class="audit-log">
                {% for event in audit_events %}
                <div class="audit-event">
                    <span class="audit-time">{{ event.timestamp }}</span>
                    <span class="audit-actor">{{ event.actor }}</span>
                    <span class="audit-action">{{ event.action }}</span>
                    {% if event.details %}
                    <span class="audit-details">{{ event.details }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Modal (Add/Edit) -->
<div id="task-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="task-modal-title">Add Task</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="task-id">

            <div class="form-group">
                <label>Title: <span class="required">*</span></label>
                <input type="text" id="task-title" class="form-input" placeholder="Task title..." required>
            </div>

            <div class="form-group">
                <label>Description:</label>
                <textarea id="task-description" class="form-textarea" rows="4" placeholder="Detailed description of what needs to be done..."></textarea>
            </div>

            <div class="form-row" style="gap: 16px;">
                <div class="form-group" style="flex: 1;">
                    <label>Priority (1-10):</label>
                    <input type="number" id="task-priority" class="form-input" min="1" max="10" value="5">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Status:</label>
                    <select id="task-status" class="form-select">
                        <option value="backlog">Backlog</option>
                        <option value="in_progress">In Progress</option>
                        <option value="blocked">Blocked</option>
                        <option value="done">Done</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Blocked By (comma-separated task IDs):</label>
                <input type="text" id="task-blocked-by" class="form-input" placeholder="e.g., T001, T002">
            </div>

            <div class="form-group">
                <label>Acceptance Criteria (one per line):</label>
                <textarea id="task-acceptance" class="form-textarea" rows="3" placeholder="- Criterion 1&#10;- Criterion 2&#10;- Criterion 3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeTaskModal()">Cancel</button>
            <button class="btn btn-primary" id="task-save-btn" onclick="saveTask()">Save</button>
        </div>
    </div>
</div>

<style>
.pipeline-stages {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 16px 0;
}
.pipeline-stage {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--bg-secondary);
    border-radius: 20px;
    font-size: 0.85rem;
}
.pipeline-stage .stage-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}
.pipeline-stage.active {
    background: var(--accent);
    color: white;
}
.pipeline-stage.active .stage-dot {
    background: white;
}
.pipeline-stage.completed .stage-dot {
    background: var(--success);
}
.pipeline-stage.failed {
    background: var(--danger);
    color: white;
}
.pipeline-stage.failed .stage-dot {
    background: white;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.control-item {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.control-item label {
    min-width: 120px;
    font-weight: 500;
}
.btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.agent-trigger-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.agent-trigger-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}
.report-card {
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border-left: 4px solid var(--border);
}
.report-card.pass {
    border-left-color: var(--success);
}
.report-card.fail {
    border-left-color: var(--danger);
}
.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}
.report-summary {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
}
.report-card:hover {
    background: var(--bg-tertiary, #f0f0f0);
}
.report-details {
    margin-top: 8px;
}
.report-details-content {
    font-size: 0.85rem;
}
.detail-section {
    margin-bottom: 8px;
}
.expand-hint {
    opacity: 0.7;
    transition: opacity 0.2s;
}
.report-card:hover .expand-hint {
    opacity: 1;
}

/* Task Filters */
.task-filters {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    flex-wrap: wrap;
}
.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}
.filter-group label {
    font-size: 0.85rem;
    color: var(--text-muted);
}
.filter-group select {
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.85rem;
}

/* Tasks Table */
.tasks-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}
.tasks-table th {
    text-align: left;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border);
    font-weight: 600;
    color: var(--text-secondary);
}
.tasks-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}
.tasks-table tr:hover {
    background: var(--bg-secondary);
}
.tasks-table tr.linked-to-run {
    border-left: 3px solid var(--accent);
}
.tasks-table tr.hidden {
    display: none;
}
.task-id {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--text-muted);
}
.task-title {
    color: var(--text-primary);
    text-decoration: none;
}
.task-title:hover {
    text-decoration: underline;
}
.priority-cell {
    text-align: center;
    font-weight: 500;
}
.badge-sm {
    font-size: 0.7rem;
    padding: 2px 6px;
    margin-left: 6px;
}
.badge-purple {
    background: #8b5cf6;
    color: white;
}
.task-actions {
    display: flex;
    gap: 4px;
    justify-content: flex-end;
}
.task-actions .btn-sm {
    padding: 4px 8px;
}
.spinner-sm {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.section-count {
    font-weight: normal;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.form-row {
    display: flex;
    gap: 8px;
}

.audit-log {
    max-height: 300px;
    overflow-y: auto;
}
.audit-event {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
}
.audit-time {
    color: var(--text-muted);
    font-family: monospace;
    font-size: 0.8rem;
}
.audit-actor {
    font-weight: 500;
    min-width: 80px;
}
.audit-action {
    color: var(--text-secondary);
}

/* Modal styles now in global app.css - removed duplicates */
</style>

<script>
const runId = {{ run.id }};
const projectId = {{ run.project_id }};

function changeState() {
    const state = document.getElementById('state-select').value;
    if (!state) return;

    fetch(`/api/runs/${runId}/set-state`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: state })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error changing state'));
}

function advanceState() {
    fetch(`/api/runs/${runId}/advance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error advancing state'));
}

function retryStage() {
    fetch(`/api/runs/${runId}/retry`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error retrying stage'));
}

function resetToDev() {
    if (!confirm('Reset to DEV stage? This will create tasks from findings.')) return;

    fetch(`/api/runs/${runId}/reset-to-dev`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error resetting to dev'));
}

function approveDeploy() {
    if (!confirm('Approve deployment?')) return;

    fetch(`/api/runs/${runId}/approve-deploy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error approving deploy'));
}

function startDeployment() {
    const envId = prompt('Enter Environment ID to deploy to:');
    if (!envId) return;

    const approver = prompt('Your name (for audit trail):');

    if (!confirm(`Start deployment to environment ${envId}?`)) return;

    fetch(`/api/runs/${runId}/deploy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            environment_id: parseInt(envId),
            approved_by: approver || 'human'
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Deployment started! It will run health checks and tests automatically.');
            window.location.reload();
        }
    })
    .catch(err => alert('Error starting deployment: ' + err));
}

function rollbackDeployment() {
    const reason = prompt('Reason for rollback:', 'Manual rollback requested');
    if (reason === null) return;  // User cancelled

    if (!confirm('Are you sure you want to rollback to the previous deployment?')) return;

    fetch(`/api/runs/${runId}/rollback`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Rollback started! The system will revert to the previous deployment.');
            window.location.reload();
        }
    })
    .catch(err => alert('Error rolling back: ' + err));
}

function killRun() {
    if (!confirm('Kill this run? This cannot be undone.')) return;

    fetch(`/api/runs/${runId}/kill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            window.location.reload();
        }
    })
    .catch(err => alert('Error killing run'));
}

function triggerAgent() {
    const agent = document.getElementById('agent-select').value;
    const prompt = document.getElementById('agent-prompt').value;

    // Show loading state
    const btn = document.querySelector('.trigger-agent-btn');
    const originalText = btn ? btn.innerHTML : '';
    if (btn) {
        btn.innerHTML = '<svg class="spinner" width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 70"/></svg> Starting...';
        btn.disabled = true;
    }

    // Call the trigger-agent API
    fetch(`/api/runs/${runId}/trigger-agent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            agent: agent,
            prompt: prompt || null,
            async: true
        })
    })
    .then(r => r.json())
    .then(data => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        if (data.status === 'started') {
            alert(`Agent ${agent.toUpperCase()} started! It will run in the background and submit results when complete.`);
            // Start polling for state changes
            setTimeout(() => window.location.reload(), 3000);
        } else if (data.error || data.message) {
            alert('Error: ' + (data.error || data.message));
        }
    })
    .catch(err => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        alert('Error triggering agent: ' + err);
    });
}

function triggerPipeline() {
    if (!confirm('Start the full pipeline? This will run PM â†’ DEV â†’ QA â†’ SEC automatically.')) {
        return;
    }

    fetch(`/api/runs/${runId}/trigger-pipeline`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ max_iterations: 10 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'started') {
            alert('Pipeline started! It will run in the background. Refresh the page to see progress.');
        } else {
            alert('Error: ' + (data.error || data.message));
        }
    })
    .catch(err => alert('Error starting pipeline: ' + err));
}

// ============================================
// Unified Task Modal (DRY - Add/Edit)
// ============================================
let isEditMode = false;

function openTaskModal(taskData = null) {
    const modal = document.getElementById('task-modal');
    const title = document.getElementById('task-modal-title');
    const saveBtn = document.getElementById('task-save-btn');

    // Reset form
    document.getElementById('task-id').value = '';
    document.getElementById('task-title').value = '';
    document.getElementById('task-description').value = '';
    document.getElementById('task-priority').value = '5';
    document.getElementById('task-status').value = 'backlog';
    document.getElementById('task-blocked-by').value = '';
    document.getElementById('task-acceptance').value = '';

    if (taskData) {
        // Edit mode
        isEditMode = true;
        title.textContent = 'Edit Task';
        saveBtn.textContent = 'Update';

        document.getElementById('task-id').value = taskData.id;
        document.getElementById('task-title').value = taskData.title || '';
        document.getElementById('task-description').value = taskData.description || '';
        document.getElementById('task-priority').value = taskData.priority || 5;
        document.getElementById('task-status').value = taskData.status || 'backlog';
        document.getElementById('task-blocked-by').value = (taskData.blocked_by || []).join(', ');
        document.getElementById('task-acceptance').value = (taskData.acceptance_criteria || []).join('\n');
    } else {
        // Add mode
        isEditMode = false;
        title.textContent = 'Add Task';
        saveBtn.textContent = 'Create';
    }

    modal.style.display = 'flex';
    document.getElementById('task-title').focus();
}

function closeTaskModal() {
    document.getElementById('task-modal').style.display = 'none';
}

// Event delegation for edit buttons (more robust than inline onclick)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.edit-task-btn');
    if (!btn) return;

    const blockedBy = btn.dataset.blockedBy || '';
    const acceptance = btn.dataset.acceptance || '';

    openTaskModal({
        id: btn.dataset.taskId,
        title: btn.dataset.title || '',
        description: btn.dataset.description || '',
        priority: parseInt(btn.dataset.priority) || 5,
        status: btn.dataset.status || 'backlog',
        blocked_by: blockedBy ? blockedBy.split(',').map(s => s.trim()).filter(s => s) : [],
        acceptance_criteria: acceptance ? acceptance.split('\n').filter(s => s.trim()) : []
    });
});

// Delete button handler is in /static/js/task-actions.js (DRY)

function saveTask() {
    const taskId = document.getElementById('task-id').value;
    const title = document.getElementById('task-title').value.trim();
    const description = document.getElementById('task-description').value.trim();
    const priority = parseInt(document.getElementById('task-priority').value) || 5;
    const status = document.getElementById('task-status').value;
    const blockedByStr = document.getElementById('task-blocked-by').value.trim();
    const acceptanceStr = document.getElementById('task-acceptance').value.trim();

    if (!title) {
        alert('Title is required');
        return;
    }

    // Parse blocked_by and acceptance_criteria
    const blocked_by = blockedByStr ? blockedByStr.split(',').map(s => s.trim()).filter(s => s) : [];
    const acceptance_criteria = acceptanceStr ? acceptanceStr.split('\n').filter(s => s.trim()) : [];

    const payload = {
        title,
        description,
        priority,
        blocked_by,
        acceptance_criteria,
        run_id: runId
    };

    let url, method;
    if (isEditMode && taskId) {
        // Update existing task
        url = `/api/tasks/${taskId}/update`;
        method = 'PATCH';
        // Also update status
        payload.status = status;
    } else {
        // Create new task
        url = `/api/projects/${projectId}/tasks/create`;
        method = 'POST';
    }

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            closeTaskModal();
            window.location.reload();
        }
    })
    .catch(err => alert('Error saving task: ' + err.message));
}

// Close modal on click outside
document.getElementById('task-modal').addEventListener('click', function(e) {
    if (e.target === this) closeTaskModal();
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTaskModal();
    }
});

// ============================================
// Task Filtering
// ============================================
function filterTasks() {
    const statusFilter = document.getElementById('filter-status').value;
    const stageFilter = document.getElementById('filter-stage').value;
    const linkedFilter = document.getElementById('filter-linked').value;

    const rows = document.querySelectorAll('#tasks-table tbody tr');
    rows.forEach(row => {
        const status = row.dataset.status;
        const stage = row.dataset.stage;
        const linked = row.dataset.linked;

        let show = true;
        if (statusFilter && status !== statusFilter) show = false;
        if (stageFilter && stage !== stageFilter) show = false;
        if (linkedFilter && linked !== linkedFilter) show = false;

        row.classList.toggle('hidden', !show);
    });
}

function clearFilters() {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-stage').value = '';
    document.getElementById('filter-linked').value = '';
    filterTasks();
}

// ============================================
// Trigger Work on Task
// ============================================
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.trigger-task-btn');
    if (!btn) return;

    const taskId = btn.dataset.taskId;
    const stage = btn.dataset.stage;

    // Determine which agent to use based on stage
    let agent = 'dev';
    if (stage === 'qa') agent = 'qa';
    else if (stage === 'sec') agent = 'security';
    else if (stage === 'docs') agent = 'docs';

    if (!confirm(`Trigger ${agent.toUpperCase()} agent to work on this task?`)) return;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';

    // For now, just advance the task to next stage (placeholder for actual agent work)
    fetch(`/api/tasks/${taskId}/advance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ result: 'pass', notes: 'Manually triggered - agent work simulated' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
        } else {
            alert(`Task advanced to ${data.new_stage || 'next stage'}`);
            window.location.reload();
        }
    })
    .catch(err => {
        alert('Error triggering task: ' + err);
        btn.disabled = false;
        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
    });
});

// ============================================
// Proof-of-Work Functions
// ============================================
function loadProofs() {
    fetch(`/api/runs/${runId}/proofs`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('proofs-container');
            if (data.proofs && data.proofs.length > 0) {
                let html = '<div class="proofs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">';
                data.proofs.forEach(proof => {
                    const isImage = proof.filename.match(/\.(png|jpg|jpeg|gif|webp)$/i);
                    const icon = proof.proof_type === 'screenshot' ? 'ðŸ“¸' : proof.proof_type === 'log' ? 'ðŸ“„' : 'ðŸ“‹';
                    html += `
                        <div class="proof-card" style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <span class="badge badge-secondary">${proof.stage || 'N/A'}</span>
                                <span style="font-size: 1.2rem;">${icon}</span>
                            </div>
                            ${isImage ? `<img src="/api/runs/${runId}/proofs/${proof.stage}/${proof.filename}" style="width: 100%; border-radius: 4px; margin-bottom: 8px; cursor: pointer;" onclick="window.open(this.src)">` : ''}
                            <div style="font-size: 0.8rem; color: var(--text-muted); word-break: break-all;">${proof.filename}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">${proof.proof_type} Â· ${Math.round(proof.size/1024)}KB</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No proofs uploaded yet.</p>';
            }
        })
        .catch(err => {
            document.getElementById('proofs-container').innerHTML = '<p style="color: var(--text-muted);">Error loading proofs</p>';
        });
}

document.getElementById('proof-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('proof-file');
    if (!fileInput.files.length) {
        alert('Please select a file');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('stage', document.getElementById('proof-stage').value);
    formData.append('proof_type', document.getElementById('proof-type').value);

    fetch(`/api/runs/${runId}/proofs/upload`, {
        method: 'POST',
        body: formData
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                fileInput.value = '';
                loadProofs();
            } else {
                alert('Error: ' + (data.error || 'Failed to upload proof'));
            }
        })
        .catch(err => alert('Error uploading proof'));
});

// Load proofs on page load
loadProofs();

// ============================================
// Report Details Toggle
// ============================================
function toggleReportDetails(card) {
    const details = card.querySelector('.report-details');
    const hint = card.querySelector('.expand-text');

    if (!details) return;

    const isHidden = details.style.display === 'none';
    details.style.display = isHidden ? 'block' : 'none';

    if (hint) {
        hint.textContent = isHidden ? 'â–² Click to hide details' : 'â–¼ Click to view details';
    }
}

// Mount React components
if (window.WH && window.WH.React) {
    {% if run.can_deploy %}
    window.WH.React.mountDeployButton({{ run.id }}, 'deploy-button-container');
    {% endif %}
    {% if run.can_rollback %}
    window.WH.React.mountRollbackButton({{ run.id }}, 'rollback-button-container');
    {% endif %}
}
</script>
{% endblock %}
