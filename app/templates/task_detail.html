{% extends "base.html" %}

{% block title %}Task: {{ task.title }} - Workflow Hub{% endblock %}
{% block page_title %}{{ task.title }}{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

<div class="card">
    <div class="card-header">
        <span id="status-badge" class="badge badge-{{ task.status_class }}" style="font-size: 0.9rem;" data-status="{{ task.status }}">{{ task.status|upper }}</span>
        <span id="priority-badge" class="badge badge-secondary" style="margin-left: 8px;">Priority: <span id="priority-value">{{ task.priority|default:5 }}</span></span>
    </div>
    <div class="card-body">
        <!-- Meta information -->
        <div class="detail-meta">
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Created: <strong>{{ task.created_at }}</strong></span>
            </div>
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>Project: <a href="/ui/project/{{ task.project_id }}/">{{ task.project_name }}</a></span>
            </div>
            {% if task.run_id %}
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                <span>Run: <a href="/ui/run/{{ task.run_id }}/">#{{ task.run_id }}</a></span>
            </div>
            {% endif %}
            <div class="detail-meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>Task ID: <strong>{{ task.task_id }}</strong></span>
            </div>
        </div>

        <!-- Editable Details Form -->
        <div class="section">
            <h4 class="section-title">Task Details</h4>
            <form id="task-details-form">
                <div style="margin-bottom: 15px;">
                    <label class="form-label">Title</label>
                    <input type="text" id="task-title" class="form-control" value="{{ task.title }}"
                        style="width: 100%;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label class="form-label">Priority</label>
                    <select id="task-priority" class="form-select" style="width: 200px;">
                        <option value="1" {% if task.priority == 1 %}selected{% endif %}>1 - Low</option>
                        <option value="3" {% if task.priority == 3 %}selected{% endif %}>3 - Medium</option>
                        <option value="5" {% if task.priority == 5 %}selected{% endif %}>5 - High</option>
                        <option value="8" {% if task.priority == 8 %}selected{% endif %}>8 - Critical</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label class="form-label">Description</label>
                    <textarea id="task-description" class="form-control" rows="6"
                        style="width: 100%;">{{ task.description|default:'' }}</textarea>
                </div>

                <div style="text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="saveTaskDetails({{ task.id }})">Save
                        Changes</button>
                </div>
            </form>
        </div>

        <!-- Blocked By -->
        {% if task.blocked_by %}
        <div class="section">
            <h4 class="section-title">Blocked By</h4>
            <div class="blocked-by-list">
                {% for blocker in task.blocked_by %}
                <span class="badge badge-danger">{{ blocker }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Attachments -->
        <div class="section">
            <h4 class="section-title">Attachments <span id="attachments-count" class="badge badge-secondary" style="font-size: 0.7rem;">{{ attachments|length }}</span></h4>
            <div id="attachments-grid" class="attachments-grid" {% if not attachments %}style="display: none;"{% endif %}>
                {% for att in attachments %}
                <div class="attachment-card">
                    {% if att.attachment_type == 'image' %}
                    <div class="attachment-preview">
                        <img src="/api/tasks/{{ task.id }}/attachments/{{ att.id }}/download" alt="{{ att.filename }}">
                    </div>
                    {% else %}
                    <div class="attachment-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    {% endif %}
                    <div class="attachment-info">
                        <span class="attachment-name">{{ att.filename }}</span>
                        <span class="attachment-size">{{ att.file_size|filesizeformat }}</span>
                    </div>
                    <a href="/api/tasks/{{ task.id }}/attachments/{{ att.id }}/download" class="btn btn-sm" download>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download
                    </a>
                </div>
                {% endfor %}
            </div>
            <p id="no-attachments-msg" style="color: var(--text-muted); font-style: italic; {% if attachments %}display: none;{% endif %}">No attachments</p>

            <!-- Upload Form -->
            <div class="upload-section">
                <h5>Add Attachment</h5>
                <form id="upload-form" enctype="multipart/form-data">
                    <input type="file" id="file-input" name="file"
                        accept=".txt,.md,.json,.xml,.csv,.png,.jpg,.jpeg,.gif,.webp">
                    <button type="submit" class="btn btn-primary">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload
                    </button>
                </form>
                <p class="upload-hint">Allowed: Images (PNG, JPG, GIF, WebP up to 10MB) and text files (TXT, MD, JSON,
                    XML, CSV up to 1MB)</p>
            </div>
        </div>

        <!-- Status Actions -->
        <div class="section">
            <h4 class="section-title">Update Status</h4>
            <div class="status-buttons">
                <button class="status-btn backlog" onclick="updateTaskStatus({{ task.id }}, 'backlog')">Backlog</button>
                <button class="status-btn in_progress" onclick="updateTaskStatus({{ task.id }}, 'in_progress')">In
                    Progress</button>
                <button class="status-btn blocked" onclick="updateTaskStatus({{ task.id }}, 'blocked')">Blocked</button>
                <button class="status-btn done" onclick="updateTaskStatus({{ task.id }}, 'done')">Done</button>
            </div>
        </div>


        <!-- Pipeline & Agent Control -->
        <div class="section">
            <h4 class="section-title">Agent Pipeline</h4>
            <div class="pipeline-controls"
                style="display: flex; gap: 10px; align-items: center; background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                <div style="flex-grow: 1;">
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Current
                        Stage: <strong id="current-stage-label">{{ task.pipeline_stage|upper }}</strong></label>
                    <select id="stage-select" class="form-select" style="width: 100%;">
                        {% for stage in pipeline_stages %}
                        <option value="{{ stage.value }}" {% if task.pipeline_stage == stage.value %}selected{% endif %}>{{ stage.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: flex-end;">
                    <button class="btn btn-secondary" id="move-stage-btn" data-task-id="{{ task.id }}">
                        Move to Stage
                    </button>
                    <!-- Prepare Task button (director enrichment) -->
                    <button class="btn btn-secondary" id="prepare-task-btn" data-task-id="{{ task.id }}" title="Director: enrich task with missing acceptance criteria">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        Prepare
                    </button>
                    <!-- Run Agent button (React with fallback) -->
                    <div id="run-agent-container">
                        <!-- Fallback button shown until React mounts -->
                        <button id="run-agent-fallback" class="btn btn-primary" onclick="triggerAgent({{ task.id }})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Run {{ task.pipeline_stage|upper }} Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Proof-of-Work Artifacts -->
        <div class="section">
            <h4 class="section-title">Proof-of-Work Artifacts</h4>
            <div id="proofs-container">
                <p style="color: var(--text-muted); font-style: italic;">Loading proofs...</p>
            </div>
            <div class="upload-section" style="margin-top: 16px;">
                <h5>Upload Proof</h5>
                <form id="proof-upload-form" enctype="multipart/form-data"
                    style="display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Stage</label>
                        <select id="proof-stage" class="form-select" style="width: 120px;">
                            {% for stage in pipeline_stages %}
                            {% if stage.value != 'none' and stage.value != 'complete' %}
                            <option value="{{ stage.value }}">{{ stage.value|upper }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Type</label>
                        <select id="proof-type" class="form-select" style="width: 120px;">
                            <option value="screenshot">Screenshot</option>
                            <option value="log">Log</option>
                            <option value="report">Report</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <input type="file" id="proof-file" name="file"
                            accept=".png,.jpg,.jpeg,.gif,.txt,.log,.md,.json,.xml,.csv" style="min-width: 200px;">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>

        <!-- Handoff History -->
        <div class="section">
            <h4 class="section-title">Handoff History <span id="handoff-count" class="badge badge-secondary" style="font-size: 0.7rem;">0</span></h4>
            <div id="handoff-history-container">
                <p style="color: var(--text-muted); font-style: italic;">Loading handoff history...</p>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="section">
            <h4 class="section-title">Activity Log</h4>
            <div id="activity-log-container">
                <p style="color: var(--text-muted); font-style: italic;">Loading activity...</p>
            </div>
        </div>

        <!-- Proof Viewer Modal -->
        <div id="proof-viewer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto;">
            <div style="background: var(--bg-primary); margin: 40px auto; max-width: 900px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border);">
                    <h4 id="proof-viewer-title" style="margin: 0;"></h4>
                    <div style="display: flex; gap: 8px;">
                        <a id="proof-download-btn" href="#" download class="btn btn-secondary btn-sm">Download</a>
                        <button onclick="closeProofViewer()" class="btn btn-sm" style="font-size: 20px; line-height: 1;">&times;</button>
                    </div>
                </div>
                <div id="proof-viewer-content" style="padding: 20px; max-height: 70vh; overflow: auto;"></div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="section" style="margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border);">
            <h4 class="section-title" style="color: var(--danger);">Danger Zone</h4>
            <button class="btn btn-danger delete-task-btn" data-task-id="{{ task.id }}" data-title="{{ task.title }}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete Task
            </button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // Toast Notification System
    // ============================================
    function showToast(message, type = 'success', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'var(--success, #28a745)' :
                       type === 'error' ? 'var(--danger, #dc3545)' :
                       type === 'warning' ? 'var(--warning, #ffc107)' : 'var(--info, #17a2b8)';
        const textColor = type === 'warning' ? '#000' : '#fff';

        toast.style.cssText = `
            background: ${bgColor}; color: ${textColor}; padding: 12px 20px;
            border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease; font-size: 0.9rem; max-width: 350px;
        `;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Add toast animations to page
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .status-btn.active { ring: 2px solid var(--primary); transform: scale(1.05); }
    `;
    document.head.appendChild(style);

    // ============================================
    // Proof Viewer Functions
    // ============================================
    function openProof(url, filename, isImage, isViewable) {
        if (isImage) {
            window.open(url);
        } else if (isViewable) {
            showProofViewer(url, filename);
        } else {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
    }

    async function showProofViewer(url, filename) {
        const modal = document.getElementById('proof-viewer-modal');
        const title = document.getElementById('proof-viewer-title');
        const content = document.getElementById('proof-viewer-content');
        const downloadBtn = document.getElementById('proof-download-btn');

        title.textContent = filename;
        downloadBtn.href = url;
        content.innerHTML = '<p style="color: var(--text-muted);">Loading...</p>';
        modal.style.display = 'block';

        try {
            const res = await fetch(url);
            const text = await res.text();
            const ext = filename.split('.').pop().toLowerCase();

            if (ext === 'md') {
                content.innerHTML = window.marked
                    ? '<div class="markdown-body">' + marked.parse(text) + '</div>'
                    : `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(text)}</pre>`;
            } else if (ext === 'html') {
                content.innerHTML = `<iframe srcdoc="${escapeHtml(text)}" style="width: 100%; height: 60vh; border: 1px solid var(--border); border-radius: 4px;"></iframe>`;
            } else if (ext === 'json') {
                try {
                    const pretty = JSON.stringify(JSON.parse(text), null, 2);
                    content.innerHTML = `<pre style="white-space: pre-wrap; background: var(--bg-secondary); padding: 16px; border-radius: 8px; overflow: auto; font-size: 0.85rem;">${escapeHtml(pretty)}</pre>`;
                } catch {
                    content.innerHTML = `<pre style="white-space: pre-wrap;">${escapeHtml(text)}</pre>`;
                }
            } else {
                content.innerHTML = `<pre style="white-space: pre-wrap; background: var(--bg-secondary); padding: 16px; border-radius: 8px; overflow: auto; font-size: 0.85rem;">${escapeHtml(text)}</pre>`;
            }
        } catch (err) {
            content.innerHTML = `<p style="color: var(--danger);">Error loading file: ${err.message}</p>`;
        }
    }

    function closeProofViewer() {
        document.getElementById('proof-viewer-modal').style.display = 'none';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal on escape or click outside
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeProofViewer(); });
    document.getElementById('proof-viewer-modal').addEventListener('click', e => {
        if (e.target.id === 'proof-viewer-modal') closeProofViewer();
    });

    // ============================================
    // Status Update (No Reload)
    // ============================================
    const statusClasses = {
        'backlog': 'secondary', 'in_progress': 'info', 'blocked': 'danger', 'done': 'success'
    };

    function updateTaskStatus(taskId, status) {
        const badge = document.getElementById('status-badge');
        const oldStatus = badge.dataset.status;

        // Optimistic UI update
        badge.textContent = status.toUpperCase().replace('_', ' ');
        badge.className = `badge badge-${statusClasses[status] || 'secondary'}`;
        badge.dataset.status = status;

        // Highlight active button
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.status-btn.${status}`)?.classList.add('active');

        fetch(`/api/tasks/${taskId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(`Status updated to ${status.replace('_', ' ')}`);
                loadActivityLog(); // Refresh activity
            } else {
                // Revert on error
                badge.textContent = oldStatus.toUpperCase().replace('_', ' ');
                badge.className = `badge badge-${statusClasses[oldStatus] || 'secondary'}`;
                badge.dataset.status = oldStatus;
                showToast(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(err => {
            badge.textContent = oldStatus.toUpperCase().replace('_', ' ');
            badge.className = `badge badge-${statusClasses[oldStatus] || 'secondary'}`;
            badge.dataset.status = oldStatus;
            showToast('Error updating status', 'error');
        });
    }

    // ============================================
    // Stage Change (No Reload)
    // ============================================
    document.getElementById('move-stage-btn').addEventListener('click', function() {
        const taskId = this.dataset.taskId;
        const stageSelect = document.getElementById('stage-select');
        const stage = stageSelect.value;
        const stageLabel = document.getElementById('current-stage-label');
        const oldStage = stageLabel.textContent;

        // Optimistic update
        stageLabel.textContent = stage.toUpperCase();

        fetch(`/api/tasks/${taskId}/set-stage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage: stage })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(`Moved to ${stage.toUpperCase()} stage`);
                loadActivityLog();
            } else {
                stageLabel.textContent = oldStage;
                showToast(data.error || 'Failed to set stage', 'error');
            }
        })
        .catch(err => {
            stageLabel.textContent = oldStage;
            showToast('Error setting stage', 'error');
        });
    });

    // ============================================
    // Run Agent Button (React with fallback)
    // ============================================
    function triggerAgent(taskId) {
        if (!confirm('Run {{ task.pipeline_stage|upper }} agent for this task?')) return;

        const btn = document.getElementById('run-agent-fallback');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-sm"></span> Starting...';

        fetch(`/api/tasks/${taskId}/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.run_id) {
                showToast(`Agent started! Run #${data.run_id}`);
                btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Running...`;
                // Poll for status
                pollAgentStatus(data.run_id, btn, originalText);
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                showToast(data.error || 'Failed to start agent', 'error');
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showToast('Error starting agent', 'error');
        });
    }

    function pollAgentStatus(runId, btn, originalText) {
        const finalStates = ['deployed', 'merged', 'ready_for_deploy', 'ready_for_commit', 'killed', 'complete'];
        const failedStates = ['qa_failed', 'sec_failed', 'testing_failed'];

        const poll = setInterval(() => {
            fetch(`/api/runs/${runId}`)
            .then(r => r.json())
            .then(data => {
                if (!data.run) {
                    clearInterval(poll);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                const state = data.run.state;
                btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> ${state.toUpperCase()}`;

                if (finalStates.includes(state) || data.run.killed) {
                    clearInterval(poll);
                    showToast(`Agent completed: ${state.toUpperCase()}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    loadProofs();
                    loadActivityLog();
                } else if (failedStates.includes(state)) {
                    clearInterval(poll);
                    showToast(`Agent failed: ${state.toUpperCase()}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    loadActivityLog();
                }
            });
        }, 3000);
    }

    // Try to mount React button (replaces fallback)
    if (window.WH && window.WH.React) {
        window.WH.React.mountRunAgentButton(
            {{ task.id }},
            '{{ task.pipeline_stage }}',
            'run-agent-container',
            {{ task.run_id|default:'null' }}
        );
    }

    // ============================================
    // Prepare Task Button
    // ============================================
    document.getElementById('prepare-task-btn').addEventListener('click', function() {
        const taskId = this.dataset.taskId;
        const btn = this;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-sm"></span> Preparing...';

        fetch(`/api/tasks/${taskId}/director/prepare`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ auto_trigger: false })
        })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalText;

            if (data.enriched) {
                showToast('Task prepared! ' + data.message);
                // Update description field if enriched
                if (data.task && data.task.description) {
                    document.getElementById('task-description').value = data.task.description;
                }
                loadActivityLog();
            } else if (data.issues && data.issues.length > 0) {
                showToast('Task needs attention', 'warning');
            } else {
                showToast(data.message || 'Task is ready', 'info');
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showToast('Error preparing task', 'error');
        });
    });

    // ============================================
    // Save Task Details (No Reload)
    // ============================================
    function saveTaskDetails(taskId) {
        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const priority = parseInt(document.getElementById('task-priority').value);

        fetch(`/api/tasks/${taskId}/update`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, priority })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Update priority badge
                document.getElementById('priority-value').textContent = priority;
                // Update page title
                document.querySelector('h1')?.childNodes[0] && (document.title = `Task: ${title} - Workflow Hub`);
                showToast('Task details saved');
                loadActivityLog();
            } else {
                showToast(data.error || 'Failed to update task', 'error');
            }
        })
        .catch(err => showToast('Error updating task', 'error'));
    }

    // ============================================
    // Attachment Upload (No Reload)
    // ============================================
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('file-input');
        if (!fileInput.files.length) {
            showToast('Please select a file', 'warning');
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        fetch(`/api/tasks/{{ task.id }}/attachments/upload`, {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.attachment) {
                const att = data.attachment;
                const grid = document.getElementById('attachments-grid');
                const noMsg = document.getElementById('no-attachments-msg');
                const countEl = document.getElementById('attachments-count');

                // Create new attachment card
                const card = document.createElement('div');
                card.className = 'attachment-card';
                const isImage = att.attachment_type === 'image';
                card.innerHTML = `
                    ${isImage ? `<div class="attachment-preview"><img src="/api/tasks/{{ task.id }}/attachments/${att.id}/download" alt="${att.filename}"></div>` :
                    `<div class="attachment-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>`}
                    <div class="attachment-info">
                        <span class="attachment-name">${att.filename}</span>
                        <span class="attachment-size">${formatFileSize(att.file_size)}</span>
                    </div>
                    <a href="/api/tasks/{{ task.id }}/attachments/${att.id}/download" class="btn btn-sm" download>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg> Download
                    </a>
                `;

                grid.appendChild(card);
                grid.style.display = '';
                noMsg.style.display = 'none';
                countEl.textContent = parseInt(countEl.textContent) + 1;

                fileInput.value = '';
                showToast(`Uploaded ${att.filename}`);
                loadActivityLog();
            } else {
                showToast(data.error || 'Failed to upload file', 'error');
            }
        })
        .catch(err => showToast('Error uploading file', 'error'));
    });

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Proof-of-Work functionality - loads both task and run proofs
    async function loadProofs() {
        const container = document.getElementById('proofs-container');
        const runId = {{ task.run_id|default:'null' }};

        try {
            // Fetch task proofs
            const taskRes = await fetch(`/api/tasks/{{ task.id }}/proofs`);
            const taskData = await taskRes.json();
            let allProofs = (taskData.proofs || []).map(p => ({...p, source: 'task'}));

            // Also fetch run proofs if task has an associated run
            if (runId) {
                const runRes = await fetch(`/api/runs/${runId}/proofs`);
                const runData = await runRes.json();
                const runProofs = (runData.proofs || []).map(p => ({...p, source: 'run', runId: runId}));
                allProofs = [...allProofs, ...runProofs];
            }

            if (allProofs.length > 0) {
                let html = '<div class="proofs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">';
                allProofs.forEach((proof, idx) => {
                    const isImage = proof.filename.match(/\.(png|jpg|jpeg|gif|webp)$/i);
                    const isViewable = proof.filename.match(/\.(md|txt|log|html|json|xml|csv)$/i);
                    const icon = proof.proof_type === 'screenshot' ? 'üì∏' : proof.proof_type === 'log' ? 'üìÑ' : 'üìã';
                    const sourceLabel = proof.source === 'run' ? `<span class="badge badge-info" style="font-size: 0.6rem;">Run #${proof.runId}</span>` : '';
                    const proofUrl = proof.source === 'run'
                        ? `/api/runs/${proof.runId}/proofs/${proof.stage}/${proof.filename}`
                        : `/api/tasks/{{ task.id }}/proofs/${proof.stage}/${proof.filename}`;
                    html += `
                        <div class="proof-card"
                             data-url="${proofUrl.replace(/"/g, '&quot;')}"
                             data-filename="${proof.filename.replace(/"/g, '&quot;')}"
                             data-is-image="${!!isImage}"
                             data-is-viewable="${!!isViewable}"
                             style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; border: 1px solid var(--border); cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div><span class="badge badge-secondary">${proof.stage || 'N/A'}</span> ${sourceLabel}</div>
                                <span style="font-size: 1.2rem;">${icon}</span>
                            </div>
                            ${isImage ? `<img src="${proofUrl}" style="width: 100%; border-radius: 4px; margin-bottom: 8px;">` : ''}
                            <div style="font-size: 0.8rem; color: var(--text-muted); word-break: break-all;">${proof.filename}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">${proof.proof_type} ¬∑ ${Math.round(proof.size / 1024)}KB</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

                // Add click handlers via event delegation
                container.querySelectorAll('.proof-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const url = card.dataset.url;
                        const filename = card.dataset.filename;
                        const isImage = card.dataset.isImage === 'true';
                        const isViewable = card.dataset.isViewable === 'true';
                        openProof(url, filename, isImage, isViewable);
                    });
                    card.addEventListener('mouseover', () => {
                        card.style.transform = 'translateY(-2px)';
                        card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    });
                    card.addEventListener('mouseout', () => {
                        card.style.transform = '';
                        card.style.boxShadow = '';
                    });
                });
            } else {
                container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No proofs uploaded yet.</p>';
            }
        } catch(err) {
            container.innerHTML = '<p style="color: var(--text-muted);">Error loading proofs</p>';
        }
    }

    document.getElementById('proof-upload-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const fileInput = document.getElementById('proof-file');
        if (!fileInput.files.length) {
            alert('Please select a file');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('stage', document.getElementById('proof-stage').value);
        formData.append('proof_type', document.getElementById('proof-type').value);

        fetch(`/api/tasks/{{ task.id }}/proofs/upload`, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    fileInput.value = '';
                    loadProofs();
                } else {
                    alert('Error: ' + (data.error || 'Failed to upload proof'));
                }
            })
            .catch(err => alert('Error uploading proof'));
    });

    // Load proofs on page load
    loadProofs();

    // Activity Log
    function loadActivityLog() {
        fetch(`/api/audit?entity_type=task&entity_id={{ task.id }}&limit=20`)
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('activity-log-container');
                if (data.events && data.events.length > 0) {
                    let html = '<div class="activity-list" style="font-size: 0.85rem;">';
                    data.events.forEach(event => {
                        const date = new Date(event.timestamp).toLocaleString();
                        const actionIcon = {
                            'create': '‚ûï', 'update': '‚úèÔ∏è', 'delete': 'üóëÔ∏è',
                            'status_change': 'üîÑ', 'stage_change': 'üìã', 'trigger': '‚ñ∂Ô∏è'
                        }[event.action] || '‚Ä¢';
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                <span style="margin-right: 8px;">${actionIcon}</span>
                                <strong>${event.action}</strong>
                                <span style="color: var(--text-muted);"> by ${event.actor || 'system'}</span>
                                <span style="float: right; color: var(--text-muted); font-size: 0.75rem;">${date}</span>
                                ${event.details ? `<div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">${JSON.stringify(event.details)}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No activity recorded yet.</p>';
                }
            })
            .catch(err => {
                document.getElementById('activity-log-container').innerHTML = '<p style="color: var(--text-muted);">Error loading activity</p>';
            });
    }
    loadActivityLog();

    // Handoff History
    function loadHandoffHistory() {
        const taskId = {{ task.id }};
        fetch(`/api/tasks/${taskId}/handoff/history`)
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('handoff-history-container');
                const countBadge = document.getElementById('handoff-count');

                if (data.handoffs && data.handoffs.length > 0) {
                    countBadge.textContent = data.handoffs.length;

                    let html = '<div class="handoff-timeline">';
                    data.handoffs.forEach(h => {
                        const created = new Date(h.created_at).toLocaleString();
                        const completed = h.completed_at ? new Date(h.completed_at).toLocaleString() : null;

                        // Status badge styling
                        let statusClass = 'badge-secondary';
                        let statusIcon = '';
                        if (h.status === 'completed') {
                            statusClass = h.report_status === 'pass' ? 'badge-success' : 'badge-danger';
                            statusIcon = h.report_status === 'pass' ? '‚úì' : '‚úó';
                        } else if (h.status === 'in_progress') {
                            statusClass = 'badge-warning';
                            statusIcon = '‚ü≥';
                        } else if (h.status === 'pending') {
                            statusClass = 'badge-info';
                            statusIcon = '‚óã';
                        } else if (h.status === 'failed') {
                            statusClass = 'badge-danger';
                            statusIcon = '!';
                        }

                        html += `
                            <div class="handoff-item" style="padding: 12px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${h.report_status === 'pass' ? 'var(--success)' : h.report_status === 'fail' ? 'var(--danger)' : 'var(--border)'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <span class="badge ${statusClass}">${statusIcon} ${h.status.toUpperCase()}</span>
                                        <span style="margin-left: 8px; font-weight: bold; text-transform: uppercase;">${h.to_role}</span>
                                        <span style="color: var(--text-muted); margin-left: 4px;">‚Üí ${h.stage}</span>
                                        ${h.from_role ? `<span style="color: var(--text-muted); font-size: 0.8rem; margin-left: 8px;">(from: ${h.from_role})</span>` : ''}
                                    </div>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">${created}</span>
                                </div>
                                ${h.report_summary ? `
                                    <div style="margin-top: 8px; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 0.9rem;">
                                        <strong>${h.report_status === 'pass' ? 'Passed: ' : 'Failed: '}</strong>${h.report_summary}
                                    </div>
                                ` : ''}
                                ${completed ? `
                                    <div style="margin-top: 4px; color: var(--text-muted); font-size: 0.75rem;">
                                        Completed: ${completed}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    countBadge.textContent = '0';
                    container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No handoffs yet. Start the pipeline to create handoffs.</p>';
                }
            })
            .catch(err => {
                console.error('Error loading handoff history:', err);
                document.getElementById('handoff-history-container').innerHTML = '<p style="color: var(--text-muted);">Error loading handoff history</p>';
            });
    }
    loadHandoffHistory();

    // Disable auto-refresh for task detail page (we have live updates)
    if (window.pauseAutoRefresh) {
        window.pauseAutoRefresh();
        // Hide the refresh indicator
        const indicator = document.getElementById('refresh-indicator');
        if (indicator) indicator.style.display = 'none';
    }
</script>
{% endblock %}