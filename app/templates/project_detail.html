{% extends "base.html" %}

{% block title %}{{ project.name }} - Workflow Hub{% endblock %}
{% block page_title %}{{ project.name }}{% endblock %}

{% block content %}
<div class="project-header">
    <div class="project-title-row">
        <h1>{{ project.name }}</h1>
        <div class="project-actions">
            <button class="btn btn-secondary" onclick="refreshProject({{ project.id }})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"></path>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh
            </button>
            <a href="/ui/projects/{{ project.id }}/board" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Task Board
            </a>
            <button class="btn btn-primary" onclick="executeProject({{ project.id }})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Execute Pipeline
            </button>
        </div>
    </div>
    <p class="project-description">{{ project.description|default:"No description" }}</p>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" onclick="showTab('overview')">Overview</button>
    <button class="tab" onclick="showTab('tasks')">Tasks ({{ tasks|length }})</button>
    <button class="tab" onclick="showTab('credentials')">Credentials ({{ credentials|length }})</button>
    <button class="tab" onclick="showTab('environments')">Environments ({{ environments|length }})</button>
    <button class="tab" onclick="showTab('settings')">Settings</button>
</div>

<!-- Overview Tab -->
<div id="tab-overview" class="tab-content active">
    <div class="grid-2">
        <!-- Project Details Card -->
        <div class="card">
            <div class="card-header">
                <h3>Project Details</h3>
                <button class="btn btn-sm" onclick="toggleEdit('project-details')">Edit</button>
            </div>
            <div class="card-body" id="project-details-view">
                <div class="detail-row">
                    <span class="detail-label">Repository Path</span>
                    <span class="detail-value">{{ project.repo_path|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Repository URL</span>
                    <span class="detail-value">
                        {% if project.repository_url %}
                        <a href="{{ project.repository_url }}" target="_blank">{{ project.repository_url }}</a>
                        {% else %}-{% endif %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Primary Branch</span>
                    <span class="detail-value">{{ project.primary_branch|default:"main" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Entry Point</span>
                    <span class="detail-value">{{ project.entry_point|default:"-" }}</span>
                </div>
            </div>
            <form class="card-body edit-form" id="project-details-edit" style="display: none;">
                <div class="form-group">
                    <label>Repository Path</label>
                    <input type="text" name="repo_path" value="{{ project.repo_path|default:'' }}"
                        placeholder="/path/to/repo">
                </div>
                <div class="form-group">
                    <label>Repository URL (HTTPS)</label>
                    <input type="url" name="repository_url" value="{{ project.repository_url|default:'' }}"
                        placeholder="https://github.com/...">
                </div>
                <div class="form-group">
                    <label>Repository URL (SSH)</label>
                    <input type="text" name="repository_ssh_url" value="{{ project.repository_ssh_url|default:'' }}"
                        placeholder="git@github.com:...">
                </div>
                <div class="form-group">
                    <label>Primary Branch</label>
                    <input type="text" name="primary_branch" value="{{ project.primary_branch|default:'main' }}">
                </div>
                <div class="form-group">
                    <label>Entry Point</label>
                    <input type="text" name="entry_point" value="{{ project.entry_point|default:'' }}"
                        placeholder="app/main.py">
                </div>
                <div class="form-group">
                    <label>Documentation URL</label>
                    <input type="url" name="documentation_url" value="{{ project.documentation_url|default:'' }}">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="toggleEdit('project-details')">Cancel</button>
                    <button type="button" class="btn btn-primary"
                        onclick="saveProjectDetails({{ project.id }})">Save</button>
                </div>
            </form>
        </div>

        <!-- Tech Stack Card -->
        <div class="card">
            <div class="card-header">
                <h3>Tech Stack</h3>
                <button class="btn btn-sm" onclick="toggleEdit('tech-stack')">Edit</button>
            </div>
            <div class="card-body" id="tech-stack-view">
                <div class="detail-row">
                    <span class="detail-label">Languages</span>
                    <span class="detail-value">
                        {% for lang in project.languages %}
                        <span class="tag">{{ lang }}</span>
                        {% empty %}-{% endfor %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Frameworks</span>
                    <span class="detail-value">
                        {% for fw in project.frameworks %}
                        <span class="tag">{{ fw }}</span>
                        {% empty %}-{% endfor %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Databases</span>
                    <span class="detail-value">
                        {% for db in project.databases %}
                        <span class="tag">{{ db }}</span>
                        {% empty %}-{% endfor %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Python Version</span>
                    <span class="detail-value">{{ project.python_version|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Node Version</span>
                    <span class="detail-value">{{ project.node_version|default:"-" }}</span>
                </div>
            </div>
            <form class="card-body edit-form" id="tech-stack-edit" style="display: none;">
                <div class="form-group">
                    <label>Languages (comma separated)</label>
                    <input type="text" name="languages" value="{{ project.languages|join:', ' }}"
                        placeholder="Python, TypeScript">
                </div>
                <div class="form-group">
                    <label>Frameworks (comma separated)</label>
                    <input type="text" name="frameworks" value="{{ project.frameworks|join:', ' }}"
                        placeholder="Django, React">
                </div>
                <div class="form-group">
                    <label>Databases (comma separated)</label>
                    <input type="text" name="databases" value="{{ project.databases|join:', ' }}"
                        placeholder="PostgreSQL, Redis">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Python Version</label>
                        <input type="text" name="python_version" value="{{ project.python_version|default:'' }}"
                            placeholder="3.11">
                    </div>
                    <div class="form-group">
                        <label>Node Version</label>
                        <input type="text" name="node_version" value="{{ project.node_version|default:'' }}"
                            placeholder="20">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="toggleEdit('tech-stack')">Cancel</button>
                    <button type="button" class="btn btn-primary"
                        onclick="saveTechStack({{ project.id }})">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="grid-2">
        <!-- Commands Card -->
        <div class="card">
            <div class="card-header">
                <h3>Commands</h3>
                <button class="btn btn-sm" onclick="toggleEdit('commands')">Edit</button>
            </div>
            <div class="card-body" id="commands-view">
                <div class="detail-row">
                    <span class="detail-label">Build</span>
                    <code class="detail-value">{{ project.build_command|default:"-" }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Test</span>
                    <code class="detail-value">{{ project.test_command|default:"-" }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Run</span>
                    <code class="detail-value">{{ project.run_command|default:"-" }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Deploy</span>
                    <code class="detail-value">{{ project.deploy_command|default:"-" }}</code>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Default Port</span>
                    <span class="detail-value">{{ project.default_port|default:"-" }}</span>
                </div>
            </div>
            <form class="card-body edit-form" id="commands-edit" style="display: none;">
                <div class="form-group">
                    <label>Build Command</label>
                    <input type="text" name="build_command" value="{{ project.build_command|default:'' }}"
                        placeholder="npm run build">
                </div>
                <div class="form-group">
                    <label>Test Command</label>
                    <input type="text" name="test_command" value="{{ project.test_command|default:'' }}"
                        placeholder="pytest">
                </div>
                <div class="form-group">
                    <label>Run Command</label>
                    <input type="text" name="run_command" value="{{ project.run_command|default:'' }}"
                        placeholder="python manage.py runserver">
                </div>
                <div class="form-group">
                    <label>Deploy Command</label>
                    <input type="text" name="deploy_command" value="{{ project.deploy_command|default:'' }}"
                        placeholder="./deploy.sh">
                </div>
                <div class="form-group">
                    <label>Default Port</label>
                    <input type="number" name="default_port" value="{{ project.default_port|default:'' }}"
                        placeholder="8000">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="toggleEdit('commands')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCommands({{ project.id }})">Save</button>
                </div>
            </form>
        </div>

        <!-- Key Files Card -->
        <div class="card">
            <div class="card-header">
                <h3>Key Files</h3>
                <button class="btn btn-sm" onclick="toggleEdit('key-files')">Edit</button>
            </div>
            <div class="card-body" id="key-files-view">
                {% for file in project.key_files %}
                <div class="file-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <span>{{ file }}</span>
                </div>
                {% empty %}
                <p class="text-muted">No key files defined</p>
                {% endfor %}
                <h4 style="margin-top: 16px;">Config Files</h4>
                {% for file in project.config_files %}
                <div class="file-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                    <span>{{ file }}</span>
                </div>
                {% empty %}
                <p class="text-muted">No config files defined</p>
                {% endfor %}
            </div>
            <form class="card-body edit-form" id="key-files-edit" style="display: none;">
                <div class="form-group">
                    <label>Key Files (one per line)</label>
                    <textarea name="key_files" rows="4"
                        placeholder="app/main.py&#10;src/index.ts">{{ project.key_files|join:'\n' }}</textarea>
                </div>
                <div class="form-group">
                    <label>Config Files (one per line)</label>
                    <textarea name="config_files" rows="4"
                        placeholder="pyproject.toml&#10;package.json">{{ project.config_files|join:'\n' }}</textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="toggleEdit('key-files')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveKeyFiles({{ project.id }})">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tasks Tab -->
<div id="tab-tasks" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Tasks</h3>
            <button class="btn btn-primary btn-sm" onclick="showModal('add-task-modal')">+ Add Task</button>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.task_id }}</td>
                        <td><a href="/ui/task/{{ task.id }}/">{{ task.title }}</a></td>
                        <td><span class="badge badge-{{ task.status_class }}">{{ task.status|upper }}</span></td>
                        <td>{{ task.priority }}</td>
                        <td>
                            <button class="btn btn-sm" onclick="executeTask({{ task.id }})" title="Execute">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No tasks yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Credentials Tab -->
<div id="tab-credentials" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Credentials</h3>
            <button class="btn btn-primary btn-sm" onclick="showModal('add-credential-modal')">+ Add Credential</button>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Service</th>
                        <th>Environment</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cred in credentials %}
                    <tr>
                        <td>{{ cred.name }}</td>
                        <td><span class="tag">{{ cred.credential_type }}</span></td>
                        <td>{{ cred.service|default:"-" }}</td>
                        <td>{{ cred.environment|default:"all" }}</td>
                        <td>
                            {% if cred.is_active %}
                            <span class="badge badge-success">Active</span>
                            {% else %}
                            <span class="badge badge-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm" onclick="editCredential({{ cred.id }})" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCredential({{ cred.id }})"
                                title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No credentials stored</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Environments Tab -->
<div id="tab-environments" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Environments</h3>
            <button class="btn btn-primary btn-sm" onclick="showModal('add-environment-modal')">+ Add
                Environment</button>
        </div>
        <div class="card-body">
            <div class="env-grid">
                {% for env in environments %}
                <div class="env-card">
                    <div class="env-card-header">
                        <h4>{{ env.name }}</h4>
                        <span class="tag tag-{{ env.env_type|lower }}">{{ env.env_type }}</span>
                    </div>
                    <div class="env-card-body">
                        {% if env.url %}
                        <div class="env-row">
                            <span class="env-label">URL</span>
                            <a href="{{ env.url }}" target="_blank">{{ env.url }}</a>
                        </div>
                        {% endif %}
                        {% if env.ssh_host %}
                        <div class="env-row">
                            <span class="env-label">SSH</span>
                            <code>{{ env.ssh_user|default:"user" }}@{{ env.ssh_host }}:{{ env.ssh_port|default:22 }}</code>
                        </div>
                        {% endif %}
                        {% if env.path %}
                        <div class="env-row">
                            <span class="env-label">Path</span>
                            <code>{{ env.path }}</code>
                        </div>
                        {% endif %}
                        <div class="env-status">
                            {% if env.is_healthy %}
                            <span class="status-dot success"></span> Healthy
                            {% elif env.is_healthy == False %}
                            <span class="status-dot danger"></span> Unhealthy
                            {% else %}
                            <span class="status-dot secondary"></span> Unknown
                            {% endif %}
                        </div>
                    </div>
                    <div class="env-card-actions">
                        <button class="btn btn-sm" onclick="editEnvironment({{ env.id }})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEnvironment({{ env.id }})">Delete</button>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No environments configured</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Settings Tab -->
<div id="tab-settings" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Project Settings</h3>
        </div>
        <div class="card-body">
            <form id="project-settings-form">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" name="name" value="{{ project.name }}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3">{{ project.description|default:'' }}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_active" {% if project.is_active %}checked{% endif %}>
                            Active
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_archived" {% if project.is_archived %}checked{% endif %}>
                            Archived
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveProjectSettings({{ project.id }})">Save
                        Settings</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h3>Danger Zone</h3>
        </div>
        <div class="card-body">
            <p class="text-muted">These actions cannot be undone.</p>
            <button class="btn btn-danger" onclick="archiveProject({{ project.id }})">Archive Project</button>
        </div>
    </div>
</div>

<!-- Add Credential Modal -->
<div id="add-credential-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Credential</h3>
            <button class="modal-close" onclick="hideModal('add-credential-modal')">&times;</button>
        </div>
        <form id="add-credential-form">
            <div class="modal-body">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" required placeholder="GitHub API Key">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="credential_type">
                            <option value="api_key">API Key</option>
                            <option value="token">Token</option>
                            <option value="oauth">OAuth</option>
                            <option value="basic_auth">Basic Auth</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="database">Database</option>
                            <option value="certificate">Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Service</label>
                        <input type="text" name="service" placeholder="github, aws, etc.">
                    </div>
                </div>
                <div class="form-group">
                    <label>Environment</label>
                    <select name="environment">
                        <option value="">All Environments</option>
                        <option value="dev">Development</option>
                        <option value="staging">Staging</option>
                        <option value="prod">Production</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="2"></textarea>
                </div>
                <hr>
                <div class="form-group">
                    <label>Username (if applicable)</label>
                    <input type="text" name="username">
                </div>
                <div class="form-group">
                    <label>API Key / Token / Password</label>
                    <input type="password" name="secret" placeholder="Enter secret value">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="hideModal('add-credential-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCredential({{ project.id }})">Save
                    Credential</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Environment Modal -->
<div id="add-environment-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Add Environment</h3>
            <button class="modal-close" onclick="hideModal('add-environment-modal')">&times;</button>
        </div>
        <form id="add-environment-form">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required placeholder="Production">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select name="env_type">
                            <option value="local">Local</option>
                            <option value="development">Development</option>
                            <option value="staging">Staging</option>
                            <option value="production">Production</option>
                            <option value="testing">Testing</option>
                            <option value="ci_cd">CI/CD</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="2"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" name="url" placeholder="https://app.example.com">
                    </div>
                    <div class="form-group">
                        <label>Health Check URL</label>
                        <input type="url" name="health_check_url" placeholder="https://app.example.com/health">
                    </div>
                </div>
                <h4>SSH Access</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>SSH Host</label>
                        <input type="text" name="ssh_host" placeholder="server.example.com">
                    </div>
                    <div class="form-group">
                        <label>SSH Port</label>
                        <input type="number" name="ssh_port" value="22">
                    </div>
                    <div class="form-group">
                        <label>SSH User</label>
                        <input type="text" name="ssh_user" placeholder="deploy">
                    </div>
                </div>
                <div class="form-group">
                    <label>Path on Server</label>
                    <input type="text" name="path" placeholder="/var/www/app">
                </div>
                <div class="form-group">
                    <label>Deploy Command</label>
                    <input type="text" name="deploy_command" placeholder="./deploy.sh">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="hideModal('add-environment-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEnvironment({{ project.id }})">Save
                    Environment</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Task Modal -->
<div id="add-task-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Task</h3>
            <button class="modal-close" onclick="hideModal('add-task-modal')">&times;</button>
        </div>
        <form id="add-task-form">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Task ID *</label>
                        <input type="text" name="task_id" required placeholder="T001">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <input type="number" name="priority" value="5" min="1" max="10">
                    </div>
                </div>
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" name="title" required placeholder="Implement feature X">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('add-task-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTask({{ project.id }})">Save Task</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    // Toggle edit mode
    function toggleEdit(section) {
        const view = document.getElementById(section + '-view');
        const edit = document.getElementById(section + '-edit');
        if (view.style.display === 'none') {
            view.style.display = 'block';
            edit.style.display = 'none';
        } else {
            view.style.display = 'none';
            edit.style.display = 'block';
        }
    }

    // Modal functions
    function showModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function hideModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // API helper
    async function apiCall(url, method, data) {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: data ? JSON.stringify(data) : undefined
        });
        return response.json();
    }

    // Project actions
    async function refreshProject(projectId) {
        const result = await apiCall('/api/projects/' + projectId + '/refresh', 'POST');
        if (result.project || !result.error) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function executeProject(projectId) {
        if (!confirm('Start pipeline execution for this project?')) return;
        const result = await apiCall('/api/projects/' + projectId + '/execute', 'POST');
        if (result.run_id) {
            alert('Pipeline started! Run ID: ' + result.run_id);
            location.href = '/ui/run/' + result.run_id + '/';
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function executeTask(taskId) {
        if (!confirm('Execute this task through the pipeline?')) return;
        const result = await apiCall('/api/tasks/' + taskId + '/execute', 'POST');
        if (result.run_id) {
            alert('Task execution started! Run ID: ' + result.run_id);
            location.href = '/ui/run/' + result.run_id + '/';
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    // Save project sections
    async function saveProjectDetails(projectId) {
        const form = document.getElementById('project-details-edit');
        const data = Object.fromEntries(new FormData(form));
        const result = await apiCall('/api/projects/' + projectId + '/update', 'PATCH', data);
        if (result.project || result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function saveTechStack(projectId) {
        const form = document.getElementById('tech-stack-edit');
        const formData = new FormData(form);
        const data = {
            languages: formData.get('languages').split(',').map(s => s.trim()).filter(s => s),
            frameworks: formData.get('frameworks').split(',').map(s => s.trim()).filter(s => s),
            databases: formData.get('databases').split(',').map(s => s.trim()).filter(s => s),
            python_version: formData.get('python_version'),
            node_version: formData.get('node_version')
        };
        const result = await apiCall('/api/projects/' + projectId + '/update', 'PATCH', data);
        if (result.project || result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function saveCommands(projectId) {
        const form = document.getElementById('commands-edit');
        const data = Object.fromEntries(new FormData(form));
        if (data.default_port) data.default_port = parseInt(data.default_port);
        const result = await apiCall('/api/projects/' + projectId + '/update', 'PATCH', data);
        if (result.project || result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function saveKeyFiles(projectId) {
        const form = document.getElementById('key-files-edit');
        const formData = new FormData(form);
        const data = {
            key_files: formData.get('key_files').split('\n').map(s => s.trim()).filter(s => s),
            config_files: formData.get('config_files').split('\n').map(s => s.trim()).filter(s => s)
        };
        const result = await apiCall('/api/projects/' + projectId + '/update', 'PATCH', data);
        if (result.project || result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function saveProjectSettings(projectId) {
        const form = document.getElementById('project-settings-form');
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            is_active: form.querySelector('[name="is_active"]').checked,
            is_archived: form.querySelector('[name="is_archived"]').checked
        };
        const result = await apiCall('/api/projects/' + projectId + '/update', 'PATCH', data);
        if (result.project || result.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    // Credential functions
    async function saveCredential(projectId) {
        const form = document.getElementById('add-credential-form');
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            credential_type: formData.get('credential_type'),
            service: formData.get('service'),
            environment: formData.get('environment'),
            description: formData.get('description'),
            username: formData.get('username'),
            api_key_encrypted: formData.get('secret')  // Will be encrypted server-side
        };
        const result = await apiCall('/api/projects/' + projectId + '/credentials/create', 'POST', data);
        if (result.credential || result.status === 'success') {
            hideModal('add-credential-modal');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function deleteCredential(credentialId) {
        if (!confirm('Delete this credential?')) return;
        const result = await apiCall('/api/credentials/' + credentialId + '/delete', 'DELETE');
        if (!result.error) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    function editCredential(credentialId) {
        // TODO: Implement edit modal
        alert('Edit credential ' + credentialId);
    }

    // Environment functions
    async function saveEnvironment(projectId) {
        const form = document.getElementById('add-environment-form');
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            env_type: formData.get('env_type'),
            description: formData.get('description'),
            url: formData.get('url'),
            health_check_url: formData.get('health_check_url'),
            ssh_host: formData.get('ssh_host'),
            ssh_port: parseInt(formData.get('ssh_port')) || 22,
            ssh_user: formData.get('ssh_user'),
            path: formData.get('path'),
            deploy_command: formData.get('deploy_command')
        };
        const result = await apiCall('/api/projects/' + projectId + '/environments/create', 'POST', data);
        if (result.environment || result.status === 'success') {
            hideModal('add-environment-modal');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    async function deleteEnvironment(environmentId) {
        if (!confirm('Delete this environment?')) return;
        const result = await apiCall('/api/environments/' + environmentId + '/delete', 'DELETE');
        if (!result.error) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    function editEnvironment(environmentId) {
        // TODO: Implement edit modal
        alert('Edit environment ' + environmentId);
    }

    // Task functions
    async function saveTask(projectId) {
        const form = document.getElementById('add-task-form');
        const formData = new FormData(form);
        const data = {
            task_id: formData.get('task_id'),
            title: formData.get('title'),
            description: formData.get('description'),
            priority: parseInt(formData.get('priority')) || 5
        };
        const result = await apiCall('/api/projects/' + projectId + '/tasks/create', 'POST', data);
        if (result.task || result.status === 'success') {
            hideModal('add-task-modal');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
</script>
{% endblock %}