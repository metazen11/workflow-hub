{% extends 'base.html' %}

{% block title %}Task Board{% if project %} - {{ project.name }}{% endif %}{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h1>
            <i class="bi bi-kanban me-2"></i>Task Board
            {% if project %}
            <small class="text-muted fs-5 ms-2">{{ project.name }}</small>
            {% endif %}
        </h1>
        {% if project %}
        <p class="text-muted mb-0">{{ project.description|truncatechars:100 }}</p>
        {% endif %}
    </div>
    <div class="col-md-6 text-end">
        <div class="d-inline-flex align-items-center gap-2">
            <!-- Search -->
            <input type="text" class="form-control form-control-sm" id="searchInput"
                   placeholder="Search tasks..." style="width: 150px;">

            <!-- Project filter (for global board) -->
            {% if projects %}
            <select class="form-select form-select-sm" id="projectFilter" style="width: auto;"
                    onchange="window.location.href = this.value ? '/ui/board/?project=' + this.value : '/ui/board/'">
                <option value="">All Projects</option>
                {% for proj in projects %}
                <option value="{{ proj.id }}" {% if proj.id == selected_project_id %}selected{% endif %}>{{ proj.name }}</option>
                {% endfor %}
            </select>
            {% endif %}

            <!-- Priority filter -->
            <select class="form-select form-select-sm" id="priorityFilter" style="width: auto;">
                <option value="all">All Priorities</option>
                <option value="high">High & Critical</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>

            {% if project %}
            <div class="vr mx-2"></div>
            <a href="/ui/project/{{ project.id }}/" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Project
            </a>
            <button class="btn btn-primary btn-sm" onclick="openTaskCreateModal({{ project.id }})">
                <i class="bi bi-plus-lg me-1"></i>New Task
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div class="kanban-board">
    <!-- Backlog -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #6c757d;">
            BACKLOG <span class="kanban-count" data-col="none">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-none" data-stage="none">
            {% for task in board.none %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- PM -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #0dcaf0;">
            PM <span class="kanban-count" data-col="pm">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-pm" data-stage="pm">
            {% for task in board.pm %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Dev -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #0d6efd;">
            DEV <span class="kanban-count" data-col="dev">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-dev" data-stage="dev">
            {% for task in board.dev %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- QA -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #ffc107; color: #000;">
            QA <span class="kanban-count" data-col="qa">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-qa" data-stage="qa">
            {% for task in board.qa %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Security -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #6f42c1;">
            SEC <span class="kanban-count" data-col="sec">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-sec" data-stage="sec">
            {% for task in board.sec %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Docs -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #20c997;">
            DOCS <span class="kanban-count" data-col="docs">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-docs" data-stage="docs">
            {% for task in board.docs %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Complete -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #198754;">
            DONE <span class="kanban-count" data-col="complete">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-complete" data-stage="complete">
            {% for task in board.complete %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Task Create Modal (shared partial) -->
{% include 'partials/task_create_modal.html' %}

<style>
    /* Kanban Board Layout */
    .kanban-board {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 8px 0 16px;
        min-height: calc(100vh - 200px);
    }

    .kanban-col {
        flex: 0 0 200px;
        min-width: 200px;
        max-width: 280px;
        max-height: calc(100vh - 180px); /* Constrain column height for scrolling */
        display: flex;
        flex-direction: column;
        background: var(--bg-card, #fff);
        border-radius: 8px;
        box-shadow: var(--shadow-sm, 0 1px 2px rgba(0,0,0,0.05));
        border: 1px solid var(--border, #e2e8f0);
    }

    .kanban-col-header {
        padding: 10px 12px;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #fff;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kanban-count {
        background: rgba(255,255,255,0.25);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }

    .kanban-col-body {
        flex: 1;
        padding: 4px 6px;
        overflow-y: auto;
        min-height: 300px;
        background: var(--bg-secondary, #f8fafc);
    }

    .kanban-column {
        transition: background-color 0.2s;
    }

    .kanban-column.drag-over {
        background-color: rgba(59, 130, 246, 0.1);
    }

    /* Task Cards - dense compact style */
    .task-card {
        cursor: grab;
        transition: transform 0.1s, box-shadow 0.1s;
        background: var(--bg-card, #fff);
        border: 1px solid var(--border, #e2e8f0);
        border-radius: 3px;
        margin-bottom: 3px;
        padding: 4px 6px;
    }

    .task-card .card-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .task-card .card-header-row {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 1px;
    }

    .task-card .task-id {
        font-size: 0.6rem;
        color: #6b7280;
        font-weight: 500;
    }

    .task-card .priority-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-left: auto;
    }

    .task-card .priority-dot.high {
        background: #dc3545;
    }

    .task-card .card-title {
        font-size: 0.7rem;
        line-height: 1.2;
        color: #1f2937;
        font-weight: 500;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .task-card:hover .task-quick-actions {
        display: block !important;
    }

    .task-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .task-card[data-priority-val="high"] {
        border-left: 3px solid #dc3545;
    }

    .task-card[data-priority-val="medium"] {
        border-left: 3px solid #ffc107;
    }

    .task-card[data-priority-val="low"] {
        border-left: 3px solid #28a745;
    }

    /* Job status indicators */
    .task-card.job-running {
        animation: pulse-border 1.5s ease-in-out infinite;
    }

    @keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
        50% { box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2); }
    }

    .job-status-badge {
        font-size: 0.65rem;
        padding: 2px 5px;
        border-radius: 3px;
    }

    .job-status-badge.running {
        background: #0d6efd;
        color: white;
        animation: pulse-bg 1s ease-in-out infinite;
    }

    .job-status-badge.queued {
        background: #ffc107;
        color: #000;
    }

    .job-status-badge.completed {
        background: #198754;
        color: white;
    }

    .job-status-badge.failed {
        background: #dc3545;
        color: white;
    }

    @keyframes pulse-bg {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Quick action buttons */
    .task-quick-actions {
        position: relative;
        z-index: 10;
    }

    .btn-xs {
        padding: 0.15rem 0.35rem;
        font-size: 0.7rem;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .kanban-col {
            flex: 0 0 180px;
            min-width: 180px;
        }
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
    }
</style>

<script src="/static/js/task-modal.js"></script>
<div class="toast-container" id="toastContainer"></div>

<script>
    // Track active jobs for live updates
    let activeJobs = new Map();
    let jobPollInterval = null;

    document.addEventListener('DOMContentLoaded', () => {
        initializeDragAndDrop();
        initializeFilters();
        updateCounts();
        initializeKeyboardShortcuts();
        startJobStatusPolling();
    });

    function initializeKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // "/" or Cmd/Ctrl+K to focus search
            if ((e.key === '/' || (e.key === 'k' && (e.metaKey || e.ctrlKey))) &&
                !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // Escape to clear search and blur
            if (e.key === 'Escape' && document.activeElement.id === 'searchInput') {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = '';
                searchInput.blur();
                searchInput.dispatchEvent(new Event('input'));
            }
        });
    }

    function initializeFilters() {
        const searchInput = document.getElementById('searchInput');
        const priorityFilter = document.getElementById('priorityFilter');

        searchInput.addEventListener('input', filterTasks);
        priorityFilter.addEventListener('change', filterTasks);

        function filterTasks() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const priority = priorityFilter.value;
            const cards = document.querySelectorAll('.task-card');

            cards.forEach(card => {
                const cardPriority = parseInt(card.dataset.priority) || 0;
                const cardTitle = card.querySelector('.card-title a')?.textContent.toLowerCase() || '';
                const cardTaskId = card.querySelector('.badge')?.textContent.toLowerCase() || '';
                let show = true;

                // Search filter
                if (searchTerm && !cardTitle.includes(searchTerm) && !cardTaskId.includes(searchTerm)) {
                    show = false;
                }

                // Priority filter
                if (show && priority !== 'all') {
                    if (priority === 'high' && cardPriority < 8) show = false;
                    if (priority === 'medium' && (cardPriority >= 8 || cardPriority <= 3)) show = false;
                    if (priority === 'low' && cardPriority > 3) show = false;
                }

                card.style.display = show ? 'block' : 'none';
            });

            updateCounts();
        }
    }

    function updateCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const visibleCards = col.querySelectorAll('.task-card:not([style*="display: none"])');
            const count = visibleCards.length;
            const badge = document.querySelector(`.kanban-count[data-col="${col.dataset.stage}"]`);
            if (badge) badge.textContent = count;
        });
    }

    // ==========================================
    // UNIFIED START WORK FLOW
    // ==========================================

    function getNextStage(currentStage) {
        const stageOrder = ['none', 'pm', 'dev', 'qa', 'sec', 'docs', 'complete'];
        const currentIndex = stageOrder.indexOf(currentStage.toLowerCase());
        if (currentIndex === -1 || currentIndex >= stageOrder.length - 1) {
            return 'dev'; // Default to dev for unknown stages
        }
        return stageOrder[currentIndex + 1];
    }

    function startWork(taskId, currentStage) {
        const nextStage = getNextStage(currentStage);

        // Skip PM for now, go straight to DEV for simplicity
        const targetStage = (nextStage === 'pm') ? 'dev' : nextStage;

        if (targetStage === 'complete') {
            showToast('Task is already complete!', 'info');
            return;
        }

        // Show loading state
        const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
        const btn = card?.querySelector('.start-work-btn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        }

        // Call unified start-work endpoint
        fetch(`/api/tasks/${taskId}/start-work`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage: targetStage })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Move card to new column
                moveCardToColumn(taskId, targetStage);

                // Track job for live updates
                if (data.job_id) {
                    activeJobs.set(taskId, {
                        jobId: data.job_id,
                        stage: targetStage,
                        runId: data.run_id
                    });
                    updateCardJobStatus(taskId, 'running', targetStage.toUpperCase());
                }

                showToast(`Started ${targetStage.toUpperCase()} agent - ${data.message}`, 'success', data.run_id);
            } else {
                showToast(`Error: ${data.error}`, 'danger');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-play-fill"></i>';
                }
            }
        })
        .catch(err => {
            showToast(`Network error: ${err.message}`, 'danger');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            }
        });
    }

    function moveCardToColumn(taskId, newStage) {
        const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
        const targetColumn = document.getElementById(`col-${newStage}`);

        if (card && targetColumn) {
            targetColumn.appendChild(card);
            card.dataset.currentStage = newStage;
            updateCounts();
        }
    }

    function updateCardJobStatus(taskId, status, label) {
        const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
        const badge = card?.querySelector('.job-status-badge');

        if (badge) {
            badge.className = `job-status-badge badge ${status}`;
            badge.textContent = label || status;
            badge.classList.remove('d-none');
        }

        if (status === 'running') {
            card?.classList.add('job-running');
        } else {
            card?.classList.remove('job-running');
        }

        // Re-enable start button
        const btn = card?.querySelector('.start-work-btn');
        if (btn && status !== 'running') {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
    }

    // ==========================================
    // LIVE JOB STATUS POLLING
    // ==========================================

    function startJobStatusPolling() {
        // Poll every 3 seconds for active jobs
        jobPollInterval = setInterval(() => {
            if (activeJobs.size === 0) return;

            activeJobs.forEach((jobInfo, taskId) => {
                fetch(`/api/tasks/${taskId}/job-status`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.has_active_job) {
                            if (data.job_status === 'completed') {
                                updateCardJobStatus(taskId, 'completed', '✓ Done');
                                showToast(`Agent completed for task`, 'success');
                                activeJobs.delete(taskId);
                                // Hide badge after 5 seconds
                                setTimeout(() => {
                                    const badge = document.querySelector(`.job-status-badge[data-task="${taskId}"]`);
                                    if (badge) badge.classList.add('d-none');
                                }, 5000);
                            } else if (data.job_status === 'failed') {
                                updateCardJobStatus(taskId, 'failed', '✗ Error');
                                showToast(`Agent failed: ${data.error_message || 'Unknown error'}`, 'danger');
                                activeJobs.delete(taskId);
                            }
                            // else still running, keep polling
                        } else {
                            // No active job, check if recently completed
                            activeJobs.delete(taskId);
                            updateCardJobStatus(taskId, '', '');
                            const badge = document.querySelector(`.job-status-badge[data-task="${taskId}"]`);
                            if (badge) badge.classList.add('d-none');
                        }
                    })
                    .catch(err => console.error('Job status poll error:', err));
            });
        }, 3000);
    }

    // ==========================================
    // DRAG AND DROP (updated to use start-work)
    // ==========================================

    function initializeDragAndDrop() {
        const draggables = document.querySelectorAll('.task-card');
        const containers = document.querySelectorAll('.kanban-column');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
            });

            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
            });
        });

        containers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                container.classList.add('drag-over');
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    const newStage = container.dataset.stage;
                    const oldStage = draggable.dataset.currentStage || 'none';

                    if (newStage !== oldStage) {
                        handleTaskMove(draggable, newStage, oldStage);
                    }
                }
            });
        });
    }

    function handleTaskMove(card, newStage, oldStage) {
        const taskId = card.dataset.taskId;
        const taskTitle = card.querySelector('.card-title')?.textContent.trim() || 'Task';

        // Actionable stages that should trigger agents
        const actionableStages = ['pm', 'dev', 'qa', 'sec', 'docs'];

        if (actionableStages.includes(newStage)) {
            // Use unified start-work flow
            const shouldStart = confirm(`Start ${newStage.toUpperCase()} agent for "${taskTitle}"?`);

            if (shouldStart) {
                // Optimistic update
                card.dataset.currentStage = newStage;
                updateCounts();

                // Call start-work (combines stage change + agent trigger)
                fetch(`/api/tasks/${taskId}/start-work`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: newStage })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.job_id) {
                        activeJobs.set(taskId, {
                            jobId: data.job_id,
                            stage: newStage,
                            runId: data.run_id
                        });
                        updateCardJobStatus(taskId, 'running', newStage.toUpperCase());
                        showToast(`Started ${newStage.toUpperCase()} agent`, 'success', data.run_id);
                    } else if (data.error) {
                        showToast(`Error: ${data.error}`, 'danger');
                        location.reload();
                    }
                })
                .catch(() => {
                    showToast('Network error', 'danger');
                    location.reload();
                });
            } else {
                // Just move without agent
                card.dataset.currentStage = newStage;
                updateCounts();
                fetch(`/api/tasks/${taskId}/set-stage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: newStage })
                });
            }
        } else {
            // Non-actionable stage (backlog, complete) - just move
            card.dataset.currentStage = newStage;
            updateCounts();
            fetch(`/api/tasks/${taskId}/set-stage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stage: newStage })
            });
        }
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ==========================================
    // TOAST NOTIFICATIONS
    // ==========================================

    function showToast(message, type = 'info', runId = null) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.style.minWidth = '300px';

        let content = message;
        if (runId) {
            content += ` <a href="/ui/run/${runId}/" class="alert-link">View Run</a>`;
        }

        toast.innerHTML = `
            ${content}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 6000);
    }

    // Close modal on Escape key (for any open modal)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && typeof closeTaskCreateModal === 'function') {
            closeTaskCreateModal();
        }
    });
</script>
{% endblock %}