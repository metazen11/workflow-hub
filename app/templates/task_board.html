{% extends 'base.html' %}

{% block title %}Task Board - {{ project.name }}{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h1>
            <i class="bi bi-kanban me-2"></i>Task Board
            <small class="text-muted fs-5 ms-2">{{ project.name }}</small>
        </h1>
        <p class="text-muted mb-0">{{ project.description|truncatechars:100 }}</p>
    </div>
    <div class="col-md-6 text-end">
        <div class="d-inline-flex align-items-center gap-2">
            <!-- Filters -->
            <select class="form-select form-select-sm" id="priorityFilter" style="width: auto;">
                <option value="all">All Priorities</option>
                <option value="high">High & Critical</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>

            <div class="vr mx-2"></div>

            <a href="/ui/project/{{ project.id }}/" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Project
            </a>
            <button class="btn btn-primary btn-sm" onclick="openTaskCreateModal({{ project.id }})">
                <i class="bi bi-plus-lg me-1"></i>New Task
            </button>
        </div>
    </div>
</div>

<div class="kanban-board">
    <!-- Backlog -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #6c757d;">
            BACKLOG <span class="kanban-count" data-col="none">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-none" data-stage="none">
            {% for task in board.none %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- PM -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #0dcaf0;">
            PM <span class="kanban-count" data-col="pm">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-pm" data-stage="pm">
            {% for task in board.pm %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Dev -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #0d6efd;">
            DEV <span class="kanban-count" data-col="dev">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-dev" data-stage="dev">
            {% for task in board.dev %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- QA -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #ffc107; color: #000;">
            QA <span class="kanban-count" data-col="qa">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-qa" data-stage="qa">
            {% for task in board.qa %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Security -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #6f42c1;">
            SEC <span class="kanban-count" data-col="sec">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-sec" data-stage="sec">
            {% for task in board.sec %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Docs -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #20c997;">
            DOCS <span class="kanban-count" data-col="docs">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-docs" data-stage="docs">
            {% for task in board.docs %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>

    <!-- Complete -->
    <div class="kanban-col">
        <div class="kanban-col-header" style="background: #198754;">
            DONE <span class="kanban-count" data-col="complete">0</span>
        </div>
        <div class="kanban-col-body kanban-column" id="col-complete" data-stage="complete">
            {% for task in board.complete %}
            {% include 'partials/kanban_card.html' with task=task %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Task Create Modal (shared partial) -->
{% include 'partials/task_create_modal.html' %}

<style>
    /* Kanban Board Layout */
    .kanban-board {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 8px 0 16px;
        min-height: calc(100vh - 200px);
    }

    .kanban-col {
        flex: 0 0 200px;
        min-width: 200px;
        max-width: 280px;
        display: flex;
        flex-direction: column;
        background: var(--bg-card, #fff);
        border-radius: 8px;
        box-shadow: var(--shadow-sm, 0 1px 2px rgba(0,0,0,0.05));
        border: 1px solid var(--border, #e2e8f0);
    }

    .kanban-col-header {
        padding: 10px 12px;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #fff;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kanban-count {
        background: rgba(255,255,255,0.25);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }

    .kanban-col-body {
        flex: 1;
        padding: 8px;
        overflow-y: auto;
        min-height: 300px;
        background: var(--bg-secondary, #f8fafc);
    }

    .kanban-column {
        transition: background-color 0.2s;
    }

    .kanban-column.drag-over {
        background-color: rgba(59, 130, 246, 0.1);
    }

    /* Task Cards */
    .task-card {
        cursor: grab;
        transition: transform 0.15s, box-shadow 0.15s;
        background: var(--bg-card, #fff);
        border: 1px solid var(--border, #e2e8f0);
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .task-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .task-card[data-priority-val="high"] {
        border-left: 3px solid #dc3545;
    }

    .task-card[data-priority-val="medium"] {
        border-left: 3px solid #ffc107;
    }

    .task-card[data-priority-val="low"] {
        border-left: 3px solid #28a745;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .kanban-col {
            flex: 0 0 180px;
            min-width: 180px;
        }
    }
</style>

<script src="/static/js/task-modal.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initializeDragAndDrop();
        initializeFilters();
        updateCounts();
    });

    function initializeFilters() {
        const priorityFilter = document.getElementById('priorityFilter');

        priorityFilter.addEventListener('change', filterTasks);

        function filterTasks() {
            const priority = priorityFilter.value;
            const cards = document.querySelectorAll('.task-card');

            cards.forEach(card => {
                const cardPriority = parseInt(card.dataset.priority) || 0;
                let show = true;

                if (priority !== 'all') {
                    if (priority === 'high' && cardPriority < 8) show = false;
                    if (priority === 'medium' && (cardPriority >= 8 || cardPriority <= 3)) show = false;
                    if (priority === 'low' && cardPriority > 3) show = false;
                }

                card.style.display = show ? 'block' : 'none';
            });

            updateCounts();
        }
    }

    function updateCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const visibleCards = col.querySelectorAll('.task-card:not([style*="display: none"])');
            const count = visibleCards.length;
            const badge = document.querySelector(`.kanban-count[data-col="${col.dataset.stage}"]`);
            if (badge) badge.textContent = count;
        });
    }

    function initializeDragAndDrop() {
        const draggables = document.querySelectorAll('.task-card');
        const containers = document.querySelectorAll('.kanban-column');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
            });

            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
            });
        });

        containers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                container.classList.add('drag-over');
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    const newStage = container.dataset.stage;
                    const oldStage = draggable.dataset.currentStage || 'none';

                    if (newStage !== oldStage) {
                        handleTaskMove(draggable, newStage);
                    }
                }
            });
        });
    }

    function handleTaskMove(card, newStage) {
        const taskId = card.dataset.taskId;
        const taskTitle = card.querySelector('.card-title').textContent.trim();

        // Define actionable stages that can trigger agents
        const actionableStages = ['dev', 'qa', 'sec', 'docs'];

        let confirmMsg = `Moved to ${newStage.toUpperCase()}.`;
        let shouldTrigger = false;

        if (actionableStages.includes(newStage)) {
            shouldTrigger = confirm(`Do you want to run the ${newStage.toUpperCase()} agent for "${taskTitle}"?`);
        }

        // Optimistic update
        card.dataset.currentStage = newStage;
        updateCounts();

        // API Call
        fetch(`/api/tasks/${taskId}/set-stage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage: newStage })
        }).then(res => {
            if (!res.ok) {
                alert('Failed to update stage on server.');
                location.reload();
            } else {
                if (shouldTrigger) {
                    triggerAgent(taskId);
                }
            }
        });
    }

    function triggerAgent(taskId) {
        // Trigger the specific task pipeline
        fetch(`/api/tasks/${taskId}/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ max_iterations: 10 })
        }).then(res => res.json())
            .then(data => {
                if (data.status === 'success' || data.run_id) {
                    // Determine CSS class based on badge content or similar helper if needed
                    // For now just alert or toast
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success position-fixed bottom-0 end-0 m-3';
                    toast.style.zIndex = 1000;
                    toast.innerHTML = `Agent triggered for task! <a href="/ui/run/${data.run_id}/" class="alert-link">View Run</a>`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                } else {
                    alert('Failed to trigger agent: ' + (data.error || 'Unknown error'));
                }
            });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Close modal on Escape key (for any open modal)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && typeof closeTaskCreateModal === 'function') {
            closeTaskCreateModal();
        }
    });
</script>
{% endblock %}