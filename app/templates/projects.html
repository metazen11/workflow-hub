{% extends "base.html" %}

{% block title %}Projects - Workflow Hub{% endblock %}
{% block page_title %}Projects{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-stats">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.active }}</div>
            <div class="stat-label">Active</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.with_tasks }}</div>
            <div class="stat-label">With Tasks</div>
        </div>
    </div>
    <button class="btn btn-primary" onclick="showModal('create-project-modal')">+ New Project</button>
</div>

<div class="card">
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Tasks</th>
                    <th>Runs</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td>
                        <a href="/ui/project/{{ project.id }}/" class="project-name">{{ project.name }}</a>
                        {% if project.repo_path %}
                        <div class="project-path">{{ project.repo_path }}</div>
                        {% endif %}
                    </td>
                    <td>{{ project.description|truncatechars:60|default:"-" }}</td>
                    <td>{{ project.task_count }}</td>
                    <td>{{ project.run_count }}</td>
                    <td>
                        {% if project.is_archived %}
                        <span class="badge badge-secondary">Archived</span>
                        {% elif project.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-warning">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="window.location='/ui/project/{{ project.id }}/'" title="View">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        <button class="btn btn-sm" onclick="executeProject({{ project.id }})" title="Execute">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">No projects yet. Create your first project!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Project Modal -->
<div id="create-project-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Project</h3>
            <button class="modal-close" onclick="hideModal('create-project-modal')">&times;</button>
        </div>
        <form id="create-project-form">
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" name="name" required placeholder="My Awesome Project">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="What does this project do?"></textarea>
                </div>
                <div class="form-group">
                    <label>Repository Path</label>
                    <input type="text" name="repo_path" placeholder="/path/to/repo">
                </div>
                <div class="form-group">
                    <label>Repository URL</label>
                    <input type="url" name="repository_url" placeholder="https://github.com/...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('create-project-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createProject()">Create Project</button>
            </div>
        </form>
    </div>
</div>

<script>
function showModal(id) {
    document.getElementById(id).classList.add('active');
}

function hideModal(id) {
    document.getElementById(id).classList.remove('active');
}

async function createProject() {
    const form = document.getElementById('create-project-form');
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        repo_path: formData.get('repo_path'),
        repository_url: formData.get('repository_url')
    };

    const response = await fetch('/api/projects/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const result = await response.json();

    if (result.status === 'success') {
        window.location.href = '/ui/project/' + result.project.id + '/';
    } else {
        alert('Error: ' + (result.error || 'Unknown error'));
    }
}

async function executeProject(projectId) {
    if (!confirm('Start pipeline execution for this project?')) return;

    const response = await fetch('/api/projects/' + projectId + '/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });
    const result = await response.json();

    if (result.status === 'success') {
        alert('Pipeline started! Run ID: ' + result.run_id);
    } else {
        alert('Error: ' + (result.error || 'Unknown error'));
    }
}

// Close modals on outside click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});
</script>
{% endblock %}
